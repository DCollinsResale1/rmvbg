<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Batch Background Removal 3</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <!-- JuxtaposeJS CSS v1.2.1 -->
  <link
    rel="stylesheet"
    href="https://cdn.knightlab.com/libs/juxtapose/1.2.1/css/juxtapose.css"
  />

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <style>
    .image-card {
      margin-bottom: 20px;
    }
    .juxtapose-wrapper-container {
      width: 100%;
      aspect-ratio: 1 / 1;
      border: 1px solid #ccc;
      overflow: hidden; 
      position: relative; 
    }
    .juxtapose-wrapper-container.img-placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background-color: #f0f0f0;
      color: #aaa;
      font-size: 0.9em;
      text-align: center;
      height: 100%;
    }
    .status-badge {
      font-size: 0.8em;
    }
    .card-footer {
      background-color: #f8f9fa;
    }
  </style>
</head>
<body class="bg-light">
  <div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1>Batch Image Background Removal</h1>
      <button id="uploadItemButton" class="btn btn-success btn-lg" disabled>
        Upload Selected Item(s)
      </button>
    </div>

    <form id="uploadForm" class="mb-4">
      <div class="mb-3">
        <label for="imageFiles" class="form-label"
          >Select Images (PNG, JPG, WebP):</label
        >
        <input
          type="file"
          class="form-control"
          id="imageFiles"
          multiple
          accept="image/png, image/jpeg, image/webp"
        />
      </div>
      <div class="row">
        <div class="col-md-4 mb-3">
          <label for="modelSelect" class="form-label">Model:</label>
          <select id="modelSelect" class="form-select">
            <option value="u2net" selected>U2Net (General Purpose)</option>
            <option value="u2netp">U2Netp (Lightweight)</option>
            <option value="u2net_human_seg">U2Net Human Segmentation</option>
            <option value="u2net_cloth_seg">U2Net Cloth Segmentation</option>
            <option value="silueta">Silueta (Alternative to U2Net)</option>
            <option value="isnet-general-use">IS-Net General Use</option>
            <option value="isnet-anime">IS-Net Anime</option>
          </select>
        </div>
        <div class="col-md-4 mb-3 d-flex align-items-end">
          <div class="form-check">
            <input
              class="form-check-input"
              type="checkbox"
              id="postProcessCheck"
            />
            <label class="form-check-label" for="postProcessCheck">
              Enable Post-Processing (Alpha Matting)
            </label>
          </div>
        </div>
        <div class="col-md-4 mb-3 d-flex align-items-end">
          <button type="submit" class="btn btn-primary w-100">
            Process Selected Images
          </button>
        </div>
      </div>
    </form>

    <hr />
    <div id="results" class="row mt-4">
      <!-- Image cards will be appended here -->
    </div>
  </div>

  <!-- JuxtaposeJS JavaScript v1.2.1 -->
  <script src="https://cdn.knightlab.com/libs/juxtapose/1.2.1/js/juxtapose.min.js"></script>

  <script>
    const submitApiUrl = "/submit";
    const statusApiUrl = "/status/";
    const apiKey = "secretApiKey"; 

    let jobFileMap = {}; 

    function updateUploadButtonStatus() {
      const anySelected =
        $('#results input[type="radio"]:checked').length > 0;
      $("#uploadItemButton").prop("disabled", !anySelected);
    }

    function initializeOrUpdateJuxtapose($card, originalImageUrl, processedImageUrl) {
      const $juxtaposeWrapper = $card.find('.juxtapose-wrapper-container');
      const originalFileName = $card.data('original-filename');
      const uniqueSliderId = 'juxtapose-' + $card.data('job-id').replace(/-/g, '');

      $juxtaposeWrapper.removeClass('img-placeholder').empty();

      // This is the div JuxtaposeJS will target for manual initialization
      const $juxtaposeDiv = $('<div>').attr('id', uniqueSliderId); 
      
      const $beforeImgTag = $('<img>')
          .attr('src', originalImageUrl)
          .attr('alt', 'Original: ' + originalFileName);
      const $afterImgTag = $('<img>')
          .attr('src', processedImageUrl + `?t=${new Date().getTime()}`)
          .attr('alt', 'Processed: ' + originalFileName);

      $juxtaposeDiv.append($beforeImgTag).append($afterImgTag);
      $juxtaposeWrapper.append($juxtaposeDiv);

      let imagesLoaded = 0;
      const totalImages = 2;

      function onImageLoad() {
          imagesLoaded++;
          if (imagesLoaded === totalImages) {
              try {
                  if (window.juxtapose && window.juxtapose.JXSlider) {
                      new juxtapose.JXSlider('#' + uniqueSliderId);
             
                      console.log("Juxtapose slider initialized for #" + uniqueSliderId);
                  } else {
                       console.warn("JuxtaposeJS v1.2.1 library (juxtapose.JXSlider) not found on window.");
                       $juxtaposeWrapper.addClass('img-placeholder').text('Slider library error.');
                  }
              } catch (e) {
                  console.error("Error initializing JuxtaposeJS v1.2.1 slider for #" + uniqueSliderId + ":", e);
                  $juxtaposeWrapper.addClass('img-placeholder').text('Error initializing slider.');
              }
          }
      }

      $beforeImgTag.on('load', onImageLoad).on('error', function() {
          console.error('Error loading original image for Juxtapose slider:', originalImageUrl);
          $juxtaposeWrapper.addClass('img-placeholder').text('Error loading original image.');
      });
      $afterImgTag.on('load', onImageLoad).on('error', function() {
          console.error('Error loading processed image for Juxtapose slider:', processedImageUrl);
          $juxtaposeWrapper.addClass('img-placeholder').text('Error loading processed image.');
      });
      
      setTimeout(() => {
          if (imagesLoaded < totalImages && !$juxtaposeWrapper.hasClass('img-placeholder')) {
               if ($beforeImgTag[0].complete && $afterImgTag[0].complete && $beforeImgTag[0].naturalWidth > 0 && $afterImgTag[0].naturalWidth > 0) {
                  if (imagesLoaded < totalImages) { 
                    console.log("Triggering onImageLoad from timeout for #" + uniqueSliderId);
                    imagesLoaded = totalImages; 
                    onImageLoad(); 
                  }
               } else if (imagesLoaded < totalImages) {
                  console.warn("Juxtapose images might be cached or failed to load for #" + uniqueSliderId + " after timeout.");
               }
          }
      }, 700); 
    }

    function pollStatus(jobId, cardElement) {
      const $card = $(cardElement);
      const $statusText = $card.find(".status-text");
      const $progressBar = $card.find(".progress-bar");
      const $juxtaposeWrapper = $card.find(".juxtapose-wrapper-container");
      const $refreshButton = $card.find(".refresh-btn");
      const originalImageUrl = $card.data("original-url");

      $.getJSON(statusApiUrl + jobId, function (data) {
        $statusText.text(
          data.status.charAt(0).toUpperCase() +
            data.status.slice(1) +
            (data.eta > 0 ? ` (ETA: ${data.eta}s)` : "")
        );
        $refreshButton.prop(
          "disabled",
          data.status === "processing" || data.status === "queued"
        );

        if (data.status === "done") {
          $statusText.html(
            '<span class="badge bg-success status-badge">✅ Done</span>'
          );
          $progressBar
            .removeClass("progress-bar-striped progress-bar-animated")
            .addClass("bg-success")
            .css("width", "100%");

          if (data.processed_image_url && originalImageUrl) {
            initializeOrUpdateJuxtapose(
              $card,
              originalImageUrl,
              data.processed_image_url
            );
          } else {
            $juxtaposeWrapper
              .addClass("img-placeholder")
              .text("Image URLs missing for slider.");
          }
          $card.data("processed-url", data.processed_image_url);
          $card
            .find(
              'input[name="image_choice_' + jobId + '"][value="processed"]'
            )
            .data("url", data.processed_image_url);
        } else if (data.status === "error") {
          $statusText.html(
            `<span class="badge bg-danger status-badge">❌ Error</span>: ${
              data.error_message || "Unknown error"
            }`
          );
          $progressBar
            .removeClass("progress-bar-striped progress-bar-animated")
            .addClass("bg-danger")
            .css("width", "100%");
          $juxtaposeWrapper
            .addClass("img-placeholder")
            .text(
              "Processing Error: " + (data.error_message || "Unknown issue")
            );
        } else if (data.status === "processing" || data.status === "queued") {
          $statusText.html(
            `<span class="badge bg-info text-dark status-badge">${
              data.status === "processing"
                ? "⚙️ Processing..."
                : "⏳ Queued..."
            }</span> (ETA: ${data.eta}s)`
          );
          $progressBar
            .addClass("progress-bar-striped progress-bar-animated")
            .removeClass("bg-success bg-danger")
            .css("width", "50%");
          setTimeout(() => pollStatus(jobId, cardElement), 2000);
        }
        updateUploadButtonStatus();
      }).fail(function () {
        $statusText.html(
          '<span class="badge bg-danger status-badge">❌ Error</span>: Failed to get status'
        );
        $progressBar
          .removeClass("progress-bar-striped progress-bar-animated")
          .addClass("bg-danger")
          .css("width", "100%");
        $juxtaposeWrapper
          .addClass("img-placeholder")
          .text("Status Check Failed.");
        $refreshButton.prop("disabled", false);
        updateUploadButtonStatus();
      });
    }

    $("#uploadForm").on("submit", function (e) {
      e.preventDefault();
      // ... (rest of the form submission logic remains the same as your last full version)
      const files = $("#imageFiles")[0].files;
      const model = $("#modelSelect").val();
      const postProcess = $("#postProcessCheck").is(":checked");

      if (files.length === 0) {
        alert("Please select one or more image files.");
        return;
      }

      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const formData = new FormData();
        formData.append("image_file", file);
        formData.append("api_key", apiKey);
        formData.append("model", model);
        formData.append("post_process", postProcess);

        const originalFileName = file.name;
        const tempJobId = `temp-${Date.now()}-${i}`; 

        const cardHtml = `
        <div class="col-md-4 image-card" id="card-${tempJobId}" data-original-filename="${originalFileName}">
          <div class="card">
            <div class="juxtapose-wrapper-container img-placeholder">
              Original: Awaiting submission<br>Processed: Queued
            </div>
            <div class="card-body">
              <h5 class="card-title small">${originalFileName}</h5>
              <div class="progress mb-2" style="height: 10px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 10%" aria-valuenow="10" aria-valuemin="0" aria-valuemax="100"></div>
              </div>
              <p class="card-text status-text"><span class="badge bg-secondary status-badge">⏳ Submitting...</span></p>
              <p class="small text-muted job-id-text">Job ID: Pending...</p>
              <div class="form-check">
                <input class="form-check-input image-select-radio" type="radio" name="image_choice_${tempJobId}" value="original" data-url="">
                <label class="form-check-label small" for="image_choice_${tempJobId}_original">Use Original</label>
              </div>
              <div class="form-check">
                <input class="form-check-input image-select-radio" type="radio" name="image_choice_${tempJobId}" value="processed" data-url="" checked>
                <label class="form-check-label small" for="image_choice_${tempJobId}_processed">Use Processed</label>
              </div>
            </div>
            <div class="card-footer text-end">
              <button class="btn btn-sm btn-outline-primary refresh-btn" data-jobid="${tempJobId}" disabled>Re-process</button>
            </div>
          </div>
        </div>`;
        const $card = $(cardHtml);
        $("#results").append($card);

        $.ajax({
          url: submitApiUrl,
          method: "POST",
          data: formData,
          processData: false,
          contentType: false,
          success: function (data) {
            if (data.job_id) {
              jobFileMap[data.job_id] = file;

              $card.attr("id", `card-${data.job_id}`);
              $card.data("job-id", data.job_id);
              $card.data("original-url", data.original_image_url);

              $card.find(".job-id-text").text(`Job ID: ${data.job_id}`);
              $card
                .find(".refresh-btn")
                .data("jobid", data.job_id)
                .prop("disabled", true);

              $card
                .find('input[name="image_choice_' + tempJobId + '"]')
                .attr("name", `image_choice_${data.job_id}`);
              $card
                .find('input[value="original"]')
                .data("url", data.original_image_url);

              $card
                .find(".juxtapose-wrapper-container.img-placeholder")
                .html(
                  `Original: Waiting for server URL<br>Processed: ${
                    data.status === "queued" ? "Queued" : "Processing..."
                  }`
                );

              pollStatus(data.job_id, $card[0]);
            } else {
              // ... (error handling for submission)
              $card.find(".status-text").html('<span class="badge bg-danger status-badge">❌ Submission Error</span>');
              $card.find(".progress-bar").addClass("bg-danger").css("width", "100%");
              $card.find(".juxtapose-wrapper-container.img-placeholder").text("Submission Error.");
            }
          },
          error: function (xhr) {
            // ... (error handling for AJAX failure)
              let errorMsg = "Submission failed.";
              if (xhr.responseJSON && xhr.responseJSON.error) { errorMsg = xhr.responseJSON.error;
              } else if (xhr.responseJSON && xhr.responseJSON.detail) {
                if (Array.isArray(xhr.responseJSON.detail)) { errorMsg = xhr.responseJSON.detail.map(d => `${d.loc.join(".")} - ${d.msg}`).join("; ");
                } else { errorMsg = xhr.responseJSON.detail; }
              }
              $card.find(".status-text").html(`<span class="badge bg-danger status-badge">❌ Error</span>: ${errorMsg}`);
              $card.find(".progress-bar").addClass("bg-danger").css("width", "100%");
              $card.find(".juxtapose-wrapper-container.img-placeholder").text("AJAX Submission Error.");
          },
        });
      }
      $("#imageFiles").val("");
    });

    $("#results").on("click", ".refresh-btn", function () {
        // ... (re-process logic remains the same as your last full version, ensuring the juxtapose-wrapper is reset)
        const jobIdToRefresh = $(this).data("jobid");
        const originalFile = jobFileMap[jobIdToRefresh];
        const $card = $(`#card-${jobIdToRefresh}`);

        if (!originalFile) { alert("Original file not found for re-processing."); return; }

        const model = $("#modelSelect").val();
        const postProcess = $("#postProcessCheck").is(":checked");
        const formData = new FormData();
        formData.append("image_file", originalFile);
        formData.append("api_key", apiKey);
        formData.append("model", model);
        formData.append("post_process", postProcess);

        $card.find(".status-text").html('<span class="badge bg-secondary status-badge">🔄 Re-submitting...</span>');
        $card.find(".progress-bar").removeClass("bg-success bg-danger").addClass("progress-bar-striped progress-bar-animated").css("width", "10%");
        $card.find(".juxtapose-wrapper-container").addClass("img-placeholder").empty().text("Re-processing... (Slider will refresh)");
        $card.find(".refresh-btn").prop("disabled", true);
        $card.data("processed-url", null);
        $card.find('input[value="processed"]').data("url", null);

        $.ajax({
            url: submitApiUrl, method: "POST", data: formData, processData: false, contentType: false,
            success: function (newData) {
                if (newData.job_id) {
                    delete jobFileMap[jobIdToRefresh]; jobFileMap[newData.job_id] = originalFile;
                    $card.attr("id", `card-${newData.job_id}`);
                    $card.data("job-id", newData.job_id); $card.data("original-url", newData.original_image_url);
                    $card.find(".job-id-text").text(`Job ID: ${newData.job_id}`);
                    $card.find(".refresh-btn").data("jobid", newData.job_id);
                    $card.find('input[type="radio"]').attr("name", `image_choice_${newData.job_id}`);
                    $card.find('input[value="original"]').data("url", newData.original_image_url);
                    $card.find(".juxtapose-wrapper-container.img-placeholder").html(`Original: Waiting for server URL<br>Processed: ${newData.status === "queued" ? "Queued" : "Processing..."}`);
                    pollStatus(newData.job_id, $card[0]);
                } else {
                    $card.find(".status-text").html('<span class="badge bg-danger status-badge">❌ Re-submission Error</span>');
                    $card.find(".refresh-btn").prop("disabled", false);
                }
            },
            error: function () {
                $card.find(".status-text").html('<span class="badge bg-danger status-badge">❌ Re-submission Failed</span>');
                $card.find(".refresh-btn").prop("disabled", false);
            }
        });
    });

    $("#uploadItemButton").on("click", function () {
        // ... (upload item logic remains the same as your last full version)
        const selectedImageUrls = [];
        $("#results .image-card").each(function () {
            const $card = $(this); const jobId = $card.data("job-id");
            if (!jobId || jobId.startsWith("temp-")) return;
            const selectedValue = $card.find(`input[name="image_choice_${jobId}"]:checked`).val();
            if (selectedValue) {
                const url = $card.find(`input[value="${selectedValue}"]`).data("url");
                if (url) { selectedImageUrls.push(encodeURIComponent(url)); }
            }
        });
        if (selectedImageUrls.length > 0) {
            const uploadUrl = `/upload-item?images=${selectedImageUrls.join("&images=")}`;
            window.open(uploadUrl, "_blank");
        } else {
            alert("No images selected or ready for upload. Please check your selections.");
        }
    });

    $("#results").on("change", ".image-select-radio", function () {
      updateUploadButtonStatus();
    });
  </script>
</body>
</html>
