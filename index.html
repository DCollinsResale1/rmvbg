<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Batch Background Removal 11</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/beerslider/dist/BeerSlider.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.5/font/bootstrap-icons.min.css">

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

  <style>
    /* Existing Styles */
    .image-card {
      margin-bottom: 20px;
      transition: opacity 0.3s ease-in-out;
    }
    .image-card.trashed-card {
        opacity: 0.6;
    }
    .beerslider-wrapper-container {
      width: 100%;
      aspect-ratio: 1 / 1;
      border: 1px solid #ccc;
      position: relative;
    }
    .beerslider-wrapper-container.img-placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background-color: #f0f0f0;
      color: #aaa;
      font-size: 0.9em;
      text-align: center;
      height: 100%;
    }
    .beer-slider img {
      display: block;
      max-width: 100%;
      height: auto;
      object-fit: contain;
    }
    .status-badge, .marker-badge {
      font-size: 0.8em;
    }
    .card-footer {
      background-color: #f8f9fa;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .trash-btn {
        color: #dc3545;
        cursor: pointer;
    }
    .trash-btn:hover { color: #bd2130; }

    /* Styles for thumbnails in modal */
    .modal-thumbnail-item {
        position: relative;
        border: 1px solid #ddd;
        padding: 5px;
        background-color: #f9f9f9;
    }
    .modal-thumbnail-item img {
        width: 80px;
        height: 80px;
        object-fit: cover;
        display: block;
    }
    .modal-thumbnail-item .remove-img-btn {
        position: absolute;
        top: -5px;
        right: -5px;
        background-color: rgba(255, 0, 0, 0.7);
        color: white;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 12px;
        line-height: 18px;
        text-align: center;
        cursor: pointer;
        padding: 0;
    }
    .modal-thumbnail-item .remove-img-btn:hover {
        background-color: rgba(200, 0, 0, 0.9);
    }


    /* New E-commerce Form Styles (from provided snippet) */
    .gtabs {
        position: relative;
        margin: auto;
        width: 100%;
    }
    .gtabs .gtab {
        background: #eee;
        position: absolute;
        opacity: 0;
        visibility: hidden;
        margin: auto;
        padding: 10px;
        top: 5px;
        transition: all 0.4s;
        width: 100%; /* Ensure gtab takes full width for centering content */
    }
    .gtabs .gtab.active {
        opacity: 1;
        visibility: visible;
        top: 0;
        transition: all 0.4s;
        position: relative; /* Change to relative when active to take space */
    }
    /* .btn.active { } */ /* This was commented out, likely not needed or handled by Bootstrap */

    .viewport { /* For QuaggaJS */
        position: relative;
        width: 100%;
        overflow: hidden;
    }
    .drawingBuffer { /* For QuaggaJS */
        position: absolute;
        top: 0;
        left: 0;
    }
    .table-container { /* Not directly used in modal, but kept if other parts of page use it */
        display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; padding: 15px;
    }
    .table-item { /* For "Draft Mode Status" checkbox in modal */
        /* flex: 1; min-width: 280px; max-width: 450px; */ /* Adjusted for modal context */
        border: 1px solid #ccc; padding: 10px; text-align: center; border-radius: 8px;
        background-color: #f9f9f9; display: flex; flex-direction: column;
        align-items: center; gap: 10px; margin-bottom: 15px;
    }
    .table-item p { font-size: 14px; font-style: italic; margin-bottom: 5px; color: #666; }

    .checkbox-container { display: flex; align-items: center; gap: 12px; }
    .checkbox-container label { font-weight: bold; display: flex; align-items: center; gap: 10px; font-size: 18px; white-space: nowrap; }
    .icon { font-size: 24px; color: #007bff; }
    .large-checkbox { width: 22px; height: 22px; transform: scale(1.5); cursor: pointer; }

    /* @@media (max-width: 600px) { .table-container { flex-direction: column; align-items: center; } } */ /* May not be relevant for modal */

    .form-box {
        background-color: #f9f9f9; border: 1px solid #ccc; border-radius: 8px;
        padding: 15px; margin-bottom: 15px; box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.05);
    }
    .form-box label { font-weight: bold; display: flex; align-items: center; gap: 8px; margin-bottom: 5px; }
    .form-box input, .form-box textarea, .form-box select {
        width: 100%; border: 1px solid #ccc; border-radius: 6px; padding: 10px; font-size: 16px;
    }
    .form-box input:focus, .form-box textarea:focus, .form-box select:focus {
        border-color: #007bff; outline: none; box-shadow: 0px 0px 8px rgba(0, 123, 255, 0.3);
    }
    .price-fields { display: flex; justify-content: space-between; gap: 15px; }
    .price-box { flex: 1; }

    .button-container { display: flex; justify-content: center; gap: 20px; margin-bottom: 20px; }
    .styled-button {
        background-color: #007bff; color: white; font-size: 18px; font-weight: bold;
        padding: 12px 25px; border: none; border-radius: 8px; transition: all 0.3s ease-in-out;
        box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.1);
    }
    .styled-button-light { background-color: #f8f9fa; color: #333; }
    .styled-button:hover, .styled-button:focus { background-color: #0056b3; box-shadow: 2px 2px 12px rgba(0, 0, 0, 0.2); transform: scale(1.05); }
    .styled-button-light:hover, .styled-button-light:focus { background-color: #e2e6ea; transform: scale(1.05); }

    #scanCounterOuter { text-align: center; font-size: 16px; font-weight: bold; margin-top: 10px; }
    #barcode-container {
        text-align: center; max-width: 100%; /* Adjusted for modal */ margin: 20px auto; padding: 10px;
        border-radius: 10px; background: #f8f9fa; box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
    }
    #barcode-scanner { position: relative; width: 100%; max-width: 480px; /* Smaller for modal */ height: auto; aspect-ratio: 640 / 480; overflow: hidden; margin: 0 auto;}
    #barcode-scanner canvas.drawingBuffer, #barcode-scanner video { position: absolute; top: 0; left: 0; width: 100% !important; height: 100% !important; }
    #barcode-scanner video { object-fit: cover; }
    #barcode-result { font-size: 18px; margin-top: 10px; color: #28a745; font-weight: bold; }
    #btnScan { margin-top: 15px; padding: 10px 20px; font-size: 16px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; transition: background 0.3s; }
    #btnScan:hover { background-color: #0056b3; }
    #modalItemLoading img { width: 50px; } /* Changed from #itemLoading */
  </style>
</head>
<body class="bg-light">
  <div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1>Batch Background Removal</h1>
      <span id="bgStatusBadge" class="badge bg-info">Checking BG Service...</span>
    </div>

    <form id="uploadForm" class="mb-4">
      <div class="mb-3">
        <label for="imageFiles" class="form-label">Select Images (PNG, JPG, WebP):</label>
        <input type="file" class="form-control" id="imageFiles" multiple accept="image/png, image/jpeg, image/webp"/>
      </div>
      <div class="row">
        <div class="col-md-4 mb-3">
          <label for="modelSelect" class="form-label">Model:</label>
          <select id="modelSelect" class="form-select">
            <option value="u2net" selected>U2Net (General Purpose)</option>
            <option value="u2netp">U2Netp (Lightweight)</option>
            <option value="u2net_human_seg">U2Net Human Segmentation</option>
            <option value="u2net_cloth_seg">U2Net Cloth Segmentation</option>
            <option value="silueta">Silueta (Alternative to U2Net)</option>
            <option value="isnet-general-use">IS-Net General Use</option>
            <option value="isnet-anime">IS-Net Anime</option>
          </select>
        </div>
        <div class="col-md-4 mb-3 d-flex align-items-end">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="postProcessCheck"/>
            <label class="form-check-label" for="postProcessCheck">Enable Post-Processing (Alpha Matting)</label>
          </div>
        </div>
        <div class="col-md-4 mb-3 d-flex align-items-end">
          <button type="submit" class="btn btn-primary w-100" id="bgremove">Process Selected Images</button>
        </div>
      </div>
    </form>

    <hr />

    <div id="attachButtonContainer" class="mb-3 text-end" style="display: none;">
        <button id="attachImagesButton" class="btn btn-info btn-lg" disabled>
            Attach Selected to Item
        </button>
    </div>

    <div id="results" class="row mt-4">
      <!-- Image cards will be appended here -->
    </div>
  </div>

  <!-- Item Attachment Modal -->
  <div class="modal fade" id="itemAttachmentModal" tabindex="-1" aria-labelledby="itemAttachmentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="itemAttachmentModalLabel">Attach Images and Enter Item Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <h6>Selected Images for Attachment:</h6>
            <div id="selectedImagesThumbnailsContainer" class="mb-3 d-flex flex-wrap gap-2">
                <!-- Thumbnails with remove buttons will be injected here -->
            </div>
            <hr>

            <div class="button-container">
                <button data-toggle="tab" data-tabs=".gtabs.modal-demo" data-tab=".modaltab-1" id="modalScanBtn"
                        class="styled-button modal-tab-trigger">
                    <i class="bi bi-upc-scan"></i> SCAN BARCODE
                </button>
                <button data-toggle="tab" data-tabs=".gtabs.modal-demo" data-tab=".modaltab-2" id="modalTypeBtn"
                        class="styled-button styled-button-light modal-tab-trigger">
                    <i class="bi bi-keyboard"></i> TYPE ITEM #
                </button>
            </div>

            <div id="modalScanCounterOuter" class="text-center mb-2">
                <span id="modalScanCounter"></span>
            </div>

            <div id="modalScanChoice" style="min-height:100px; margin-bottom:20px;" class="gtabs modal-demo">
                <div style="width:100%" class="gtab active modaltab-1">
                    <div class="text-center">
                        <input style="width:auto; display:inline-block" type="button" id="btnModalScanStart" value="Activate Barcode Reader" class="btn btn-primary btn-lg" />
                    </div>
                </div>
                <div style="width:100%" class="gtab modaltab-2">
                    <div id="modalItemNumberLookupField" class="d-flex justify-content-center align-items-center gap-2">
                        <span>TYPE ITEM NUMBER:</span>
                        <input required type="text" class="form-control" id="modalItemNumber" name="modalItemNumber" style="width:150px; display:inline;" />
                        <input style="width:100px;display:inline" type="button" id="btnModalLookup" value="Lookup" class="btn btn-secondary" />
                    </div>
                </div>
            </div>
            <div id="modalItemLoading" class="text-center" style="display:none;">
                <img src="/images/Circles-menu-3.gif" alt="Loading..." /> <!-- Adjust path if needed -->
            </div>
            <div id="barcode-container" style="display:none;">
                <h5 class="text-center">Barcode Scanner</h5>
                <div id="barcode-scanner">
                    <video autoplay playsinline></video>
                    <canvas class="drawingBuffer"></canvas>
                </div>
                <p id="barcode-result" class="text-center">Waiting for scan...</p>
            </div>

            <form id="itemAttachmentForm">
                <input type="hidden" id="finalItemNumberForSubmission" name="finalItemNumberForSubmission">

                <div class="form-box">
                    <label for="modalTitle"><i class="bi bi-tag icon"></i> Title:</label>
                    <input required type="text" class="form-control" id="modalTitle" name="title">
                </div>

                <div class="form-box">
                    <div class="price-fields">
                        <div class="price-box">
                            <label for="modalPrice"><i class="bi bi-bag icon"></i> In-Store Price</label>
                            <input required type="text" class="form-control" id="modalPrice" name="price" pattern="^\$\d{1,3}(,\d{3})*(\.\d+)?$">
                        </div>
                        <div class="price-box">
                            <label for="modalPriceWithSurcharge"><i class="bi bi-globe icon"></i> Online Price</label>
                            <input required type="text" class="form-control" id="modalPriceWithSurcharge" name="pricewithsurcharge" pattern="^\$\d{1,3}(,\d{3})*(\.\d+)?$">
                        </div>
                    </div>
                </div>

                <div class="form-box">
                    <label for="modalDescription"><i class="bi bi-pencil-square icon"></i> Description</label>
                    <textarea required name="description" id="modalDescription" rows="4" class="form-control"></textarea>
                </div>

                <div class="form-box">
                    <label for="modalNewPrice"><i class="bi bi-tag icon"></i> Comparison New Price (Optional)</label>
                    <input type="text" class="form-control" id="modalNewPrice" name="newprice" pattern="^\$\d{1,3}(,\d{3})*(\.\d+)?$">
                </div>

                <div class="form-box">
                    <label for="modalMoreTags"><i class="bi bi-tags icon"></i> Additional Tags (Optional)</label>
                    <input type="text" class="form-control" id="modalMoreTags" name="moretags">
                </div>

                <div class="form-box">
                    <label for="modalCondition"><i class="bi bi-box icon"></i> Item Condition</label>
                    <select class="form-select form-select-lg" id="modalCondition" name="condition">
                        <option value="GENTLY USED">🛠️ Gently Used: Item is gently used and may have some wear.</option>
                        <option value="LIKE NEW">✨ Like New: Item is like new, but no longer has tags attached.</option>
                        <option value="NEW">🏷️ NWT: Item is new and still has manufacturer tags attached.</option>
                    </select>
                </div>

                <div class="table-item">
                    <div class="checkbox-container">
                        <label for="modalStatus" style="font-size:16px;">
                            <i class="bi bi-pencil-square icon"></i> Draft Mode Status?
                        </label>
                        <input type="checkbox" class="form-check-input large-checkbox" id="modalStatus" name="status" value="draft">
                    </div>
                </div>
                <div id="modalAlertPlaceholder"></div>
            </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary" form="itemAttachmentForm">Submit Item and Attach Images</button>
        </div>
      </div>
    </div>
  </div>

  <!-- JavaScript Includes -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/beerslider/dist/BeerSlider.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/compressorjs/1.1.1/compressor.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/webrtc-adapter/9.0.3/adapter.js"></script>
  <script src="https://resale.one/lib/quagga2/quagga.js"></script>
  <script src="https://resale.one/view-resources/Areas/App/Views/ECommerce/live_w_locator.js?v=22322222625523529"></script>
  <script src="https://resale.one/view-resources/Areas/App/Views/ECommerce/script2025.js?v=259er"></script>

  <script>
    const submitApiUrl = "/submit"; // Replace with your actual submit API endpoint
    const statusApiUrl = "/status/"; // Replace with your actual status API endpoint
    // IMPORTANT: Replace with your ngrok URL (or actual public URL) and ensure it's HTTPS if your page is.
    const associateApiUrl = "https://bc41-173-93-246-50.ngrok-free.app/EComm/WebFormUpload2";
    const apiKey = "secretApiKey"; // IMPORTANT: Replace with your actual API key

    const ASSOCIATED_JOB_IDS_KEY = 'batchUploader_associatedJobIds';
    const TRASHED_JOB_IDS_KEY = 'batchUploader_trashedJobIds';

    let jobFileMap = {}; // Stores { jobId: FileObject } for potential re-processing
    let sliderInstances = {}; // Stores { sliderContainerId: BeerSliderInstance }
    let itemAttachmentModalInstance;
    let quaggaScannerInitialized = false;

    // --- LocalStorage Helper Functions ---
    function getStoredJobIds(key) {
        const stored = localStorage.getItem(key);
        return stored ? JSON.parse(stored) : [];
    }
    function addJobIdToStorage(key, jobId) {
        let currentJobIds = getStoredJobIds(key);
        if (jobId && !currentJobIds.includes(jobId)) {
            currentJobIds.push(jobId);
            localStorage.setItem(key, JSON.stringify(currentJobIds));
        }
    }
    function removeJobIdFromStorage(key, jobId) {
        let currentJobIds = getStoredJobIds(key);
        if (jobId) {
            const index = currentJobIds.indexOf(jobId);
            if (index > -1) {
                currentJobIds.splice(index, 1);
                localStorage.setItem(key, JSON.stringify(currentJobIds));
            }
        }
    }
    function isJobAssociated(jobId) {
        return jobId ? getStoredJobIds(ASSOCIATED_JOB_IDS_KEY).includes(jobId) : false;
    }
    function isJobTrashed(jobId) {
        return jobId ? getStoredJobIds(TRASHED_JOB_IDS_KEY).includes(jobId) : false;
    }

    // --- UI Update & Sorting Functions ---
    function updateAttachButtonStatus() {
      const anyCardsPresent = $('#results .image-card').length > 0;
      const $attachButtonContainer = $("#attachButtonContainer");
      const $attachButton = $("#attachImagesButton");

      if (anyCardsPresent) {
        $attachButtonContainer.show();
        const anySelectedForAttachment = $('#results .image-card:not(.trashed-card) .select-for-attachment:checked').length > 0;
        $attachButton.prop("disabled", !anySelectedForAttachment);
      } else {
        $attachButtonContainer.hide();
        $attachButton.prop("disabled", true);
      }
    }

    function applyCardState(jobId) {
        const $card = $(`#card-${jobId}`);
        if (!$card.length || !jobId) return;

        const associated = isJobAssociated(jobId);
        const trashed = isJobTrashed(jobId);

        $card.find('.associated-marker').toggle(associated && !trashed);
        $card.find('.trashed-marker').toggle(trashed);
        $card.toggleClass('trashed-card', trashed);

        $card.find('.select-for-attachment').prop('disabled', trashed);
        if (trashed) {
            $card.find('.select-for-attachment').prop('checked', false);
        }
    }

    function sortImageCards() {
        const $resultsContainer = $("#results");
        const $cards = $resultsContainer.children(".image-card").get();

        $cards.sort(function(a, b) {
            const $a = $(a);
            const $b = $(b);
            const aJobId = $a.data('job-id');
            const bJobId = $b.data('job-id');

            if (!aJobId || String(aJobId).startsWith('temp-')) return 1; // Temp cards at the bottom or sort by filename
            if (!bJobId || String(bJobId).startsWith('temp-')) return -1;

            const aTrashed = isJobTrashed(aJobId);
            const bTrashed = isJobTrashed(bJobId);
            const aAssociated = isJobAssociated(aJobId);
            const bAssociated = isJobAssociated(bJobId);
            const aFilename = ($a.data('original-filename') || '').toLowerCase();
            const bFilename = ($b.data('original-filename') || '').toLowerCase();

            // Non-trashed, non-associated first
            if (!aTrashed && !aAssociated && (bTrashed || bAssociated)) return -1;
            if ((aTrashed || aAssociated) && !bTrashed && !bAssociated) return 1;

            // Among non-trashed, non-associated: sort by filename
            if (!aTrashed && !aAssociated && !bTrashed && !bAssociated) return aFilename.localeCompare(bFilename);

            // Non-trashed, associated next
            if (!aTrashed && aAssociated && bTrashed) return -1; // a (assoc, not trashed) before b (trashed)
            if (aTrashed && !bTrashed && bAssociated) return 1;  // a (trashed) after b (assoc, not trashed)

            // Both associated (and not trashed) or both not associated (and not trashed) - sort by filename
            if ((aAssociated === bAssociated) && (aTrashed === bTrashed)) return aFilename.localeCompare(bFilename);

            // Trashed items last
            if (aTrashed && !bTrashed) return 1;
            if (!aTrashed && bTrashed) return -1;

            // Both trashed: sort by filename
            if (aTrashed && bTrashed) return aFilename.localeCompare(bFilename);

            return aFilename.localeCompare(bFilename); // Default fallback
        });
        $.each($cards, function(idx, itm) { $resultsContainer.append(itm); });
        updateAttachButtonStatus();
    }


    // --- BeerSlider Initialization ---
    function initializeOrUpdateBeerSlider($card, originalImageUrl, processedImageUrl) {
      const $sliderWrapper = $card.find('.beerslider-wrapper-container');
      const originalFileName = $card.data('original-filename');
      const jobId = $card.data('job-id');
      if (!jobId) {
          console.error("Cannot init BeerSlider: Job ID missing from card.", $card);
          $sliderWrapper.addClass('img-placeholder').text('Error: Slider Job ID missing.');
          return;
      }
      const sliderContainerId = 'beer-slider-' + String(jobId).replace(/[^a-zA-Z0-9-_]/g, ''); // Sanitize ID

      // Clear previous slider if exists to prevent conflicts
      if (sliderInstances[sliderContainerId]) {
          // BeerSlider doesn't have a built-in destroy. We remove and re-add.
          // Or, if re-init works, that's fine too. For safety, let's clear.
          $sliderWrapper.empty();
          delete sliderInstances[sliderContainerId];
      }
      $sliderWrapper.removeClass('img-placeholder').empty();

      const $beerSliderDiv = $('<div>').attr('id', sliderContainerId).addClass('beer-slider');
      const $beforeImgTag = $('<img>').attr('src', originalImageUrl).attr('alt', 'Original: ' + originalFileName);
      const $beerRevealDiv = $('<div>').addClass('beer-reveal');
      // Add cache-busting query param to processed image
      const cacheBustProcessedUrl = processedImageUrl + (processedImageUrl.includes('?') ? '&' : '?') + `t=${new Date().getTime()}`;
      const $afterImgTag = $('<img>').attr('src', cacheBustProcessedUrl).attr('alt', 'Processed: ' + originalFileName);

      $beerRevealDiv.append($afterImgTag);
      $beerSliderDiv.append($beforeImgTag).append($beerRevealDiv);
      $sliderWrapper.append($beerSliderDiv);

      let imagesLoaded = 0;
      const totalImages = 2;
      function onImageLoad() {
          imagesLoaded++;
          if (imagesLoaded === totalImages) {
              try {
                  if (window.BeerSlider) {
                      const sliderElement = document.getElementById(sliderContainerId);
                      if (sliderElement) {
                          sliderInstances[sliderContainerId] = new BeerSlider(sliderElement, { start: 50 });
                      } else {
                          console.error("BeerSlider element not found after appending:", sliderContainerId);
                          $sliderWrapper.addClass('img-placeholder').text('Slider DOM Error.');
                      }
                  } else {
                      console.error("BeerSlider library not loaded.");
                      $sliderWrapper.addClass('img-placeholder').text('Slider library error.');
                  }
              } catch (e) {
                  console.error("Error initializing BeerSlider:", e);
                  $sliderWrapper.addClass('img-placeholder').text('Error initializing slider.');
              }
          }
      }
      $beforeImgTag.on('load', onImageLoad).on('error', () => {
          console.error("Error loading original image for slider:", originalImageUrl);
          $sliderWrapper.addClass('img-placeholder').text('Error loading original image.');
          // Try to trigger onImageLoad anyway if the other one might load, to avoid deadlock
          // onImageLoad();
      });
      $afterImgTag.on('load', onImageLoad).on('error', () => {
          console.error("Error loading processed image for slider:", cacheBustProcessedUrl);
          $sliderWrapper.addClass('img-placeholder').text('Error loading processed image.');
          // onImageLoad();
      });

      // Fallback in case load events don't fire (e.g., cached images)
      setTimeout(() => {
          if (imagesLoaded < totalImages && !$sliderWrapper.hasClass('img-placeholder')) {
               if ($beforeImgTag.length && $beforeImgTag[0].complete && $beforeImgTag[0].naturalWidth > 0 &&
                   $afterImgTag.length && $afterImgTag[0].complete && $afterImgTag[0].naturalWidth > 0) {
                  if (imagesLoaded === 0) { onImageLoad(); onImageLoad(); }
                  else if (imagesLoaded === 1) { onImageLoad(); }
               }
          }
      }, 700); // Wait a bit for images to potentially be loaded from cache
    }

    // --- Poll Status Function ---
    function pollStatus(jobId, cardElement) {
      const $card = $(cardElement);
      const $statusText = $card.find(".status-text");
      const $progressBar = $card.find(".progress-bar");
      const $sliderWrapper = $card.find(".beerslider-wrapper-container");
      const $refreshButton = $card.find(".refresh-btn");
      const originalImageUrl = $card.data("original-url"); // Ensure this is set when card is created

      $.getJSON(statusApiUrl + jobId, function (data) {
        $statusText.text(data.status.charAt(0).toUpperCase() + data.status.slice(1) + (data.eta > 0 ? ` (ETA: ${data.eta}s)` : ""));
        $refreshButton.prop("disabled", data.status === "processing" || data.status === "queued");

        if (data.status === "done") {
          $statusText.html('<span class="badge bg-success status-badge">✅ Done</span>');
          $progressBar.removeClass("progress-bar-striped progress-bar-animated").addClass("bg-success").css("width", "100%");
          if (data.processed_image_url && originalImageUrl) {
            initializeOrUpdateBeerSlider($card, originalImageUrl, data.processed_image_url);
          } else {
            console.warn("Image URLs missing for slider. Original:", originalImageUrl, "Processed:", data.processed_image_url);
            $sliderWrapper.addClass("img-placeholder").text("Image URLs missing for slider.");
          }
          $card.data("processed-url", data.processed_image_url);
          // Ensure radio button data-url is updated
          const radioName = `image_choice_${jobId}`;
          $card.find(`input[name="${radioName}"][value="processed"]`).data("url", data.processed_image_url);

          applyCardState(jobId); sortImageCards();
        } else if (data.status === "error") {
          $statusText.html(`<span class="badge bg-danger status-badge">❌ Error</span>: ${data.error_message || "Unknown error"}`);
          $progressBar.removeClass("progress-bar-striped progress-bar-animated").addClass("bg-danger").css("width", "100%");
          $sliderWrapper.addClass("img-placeholder").text("Processing Error: " + (data.error_message || "Unknown issue"));
          applyCardState(jobId); sortImageCards();
        } else if (data.status === "processing" || data.status === "queued") {
          const statusMsg = data.status === "processing" ? "⚙️ Processing..." : "⏳ Queued...";
          $statusText.html(`<span class="badge bg-info text-dark status-badge">${statusMsg}</span> (ETA: ${data.eta}s)`);
          $progressBar.addClass("progress-bar-striped progress-bar-animated").removeClass("bg-success bg-danger").css("width", "50%");
          setTimeout(() => pollStatus(jobId, cardElement), 3000); // Poll slightly less frequently
        } else {
            $statusText.html(`<span class="badge bg-warning text-dark status-badge">⚠️ Unknown Status</span>: ${data.status}`);
            $progressBar.removeClass("progress-bar-striped progress-bar-animated").addClass("bg-warning").css("width", "100%");
        }
      }).fail(function (xhr) {
        $statusText.html('<span class="badge bg-danger status-badge">❌ Error</span>: Failed to get status');
        $progressBar.removeClass("progress-bar-striped progress-bar-animated").addClass("bg-danger").css("width", "100%");
        $sliderWrapper.addClass("img-placeholder").text("Status Check Failed.");
        $refreshButton.prop("disabled", false); // Allow retry
        console.error("Poll status failed for Job ID:", jobId, xhr);
        // Don't sort or apply state if status check fails, might hide real issue.
      });
    }

    // --- Barcode Scanner Functions (QuaggaJS) ---
    function initQuaggaScanner() {
        if (typeof Quagga === 'undefined') {
            console.error("QuaggaJS not loaded.");
            $('#barcode-result').text("Scanner library not loaded.");
            return;
        }
        if (quaggaScannerInitialized && Quagga.CameraAccess.getActiveStreamLabel()) { // Check if stream is active
            console.log("Quagga already initialized and stream might be active. Restarting if needed.");
            Quagga.stop(); // Stop previous instance before restarting
        }

        const $video = $('#barcode-scanner video')[0];
        const $barcodeContainer = $('#barcode-container');
        const $barcodeResult = $('#barcode-result');

        if (!$video) {
            console.error("Video element for scanner not found.");
            $barcodeResult.text("Scanner video element missing.");
            return;
        }
        $barcodeContainer.show();
        $barcodeResult.text("Initializing scanner...");

        Quagga.init({
            inputStream: {
                name: "Live",
                type: "LiveStream",
                target: $video,
                constraints: {
                    width: { min: 640, ideal: 640 }, // Adjusted ideal
                    height: { min: 480, ideal: 480 }, // Adjusted ideal
                    facingMode: "environment",
                    aspectRatio: { min: 1, max: 2 }
                },
            },
            decoder: {
                readers: ["ean_reader", "ean_8_reader", "code_128_reader", "code_39_reader", "upc_reader", "upc_e_reader", "codabar_reader"],
                debug: {
                    drawBoundingBox: true,
                    showFrequency: false, // Less verbose
                    drawScanline: true,
                    showPattern: false // Less verbose
                },
                multiple: false
            },
            locate: true,
            locator: {
                patchSize: "medium",
                halfSample: true
            },
            numOfWorkers: navigator.hardwareConcurrency ? Math.max(1, navigator.hardwareConcurrency -1) : 2, // Adjusted workers
            frequency: 10, // Scan frequency
        }, function (err) {
            if (err) {
                console.error("Quagga initialization failed:", err);
                $barcodeResult.text("Scanner init failed: " + (err.message || err));
                $barcodeContainer.hide();
                // Try to provide more specific error messages
                if (err.name === 'NotAllowedError') {
                     $barcodeResult.text("Camera access denied. Please allow camera permissions.");
                } else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
                     $barcodeResult.text("No camera found. Please ensure a camera is connected and enabled.");
                } else if (err.name === 'NotReadableError' || err.name === 'TrackStartError') {
                     $barcodeResult.text("Camera is already in use or unreadable.");
                }
                return;
            }
            console.log("Quagga initialization finished. Ready to start.");
            Quagga.start();
            quaggaScannerInitialized = true;
            $barcodeResult.text("Scanner active. Aim at barcode.");
        });

        Quagga.onProcessed(function (result) {
            var drawingCtx = Quagga.canvas.ctx.overlay,
                drawingCanvas = Quagga.canvas.dom.overlay;

            if (result) {
                if (result.boxes) {
                    drawingCtx.clearRect(0, 0, parseInt(drawingCanvas.getAttribute("width")), parseInt(drawingCanvas.getAttribute("height")));
                    result.boxes.filter(function (box) {
                        return box !== result.box;
                    }).forEach(function (box) {
                        Quagga.ImageDebug.drawPath(box, { x: 0, y: 1 }, drawingCtx, { color: "green", lineWidth: 2 });
                    });
                }
                if (result.box) {
                    Quagga.ImageDebug.drawPath(result.box, { x: 0, y: 1 }, drawingCtx, { color: "#00F", lineWidth: 2 });
                }
            }
        });

        Quagga.onDetected(function (result) {
            const code = result.codeResult.code;
            console.log("Barcode detected:", code);
            $barcodeResult.text("Detected: " + code);
            $('#modalItemNumber').val(code).trigger('change'); // Update item number field
            stopQuaggaScanner();
            // $barcodeContainer.hide(); // Hide after successful scan
            $('#modalTypeBtn').trigger('click'); // Switch to type tab for user to confirm/lookup
            // Optionally trigger lookup if LookupItem is robust
            // if (typeof LookupItem === "function") {
            //    $('#btnModalLookup').trigger('click');
            // }
        });
    }

    function stopQuaggaScanner() {
        if (quaggaScannerInitialized && typeof Quagga !== 'undefined' && Quagga.CameraAccess.getActiveStreamLabel()) {
            Quagga.stop();
            console.log("Quagga stopped.");
            $('#barcode-container').hide(); // Hide when stopped
            quaggaScannerInitialized = false; // Reset flag or handle re-init carefully
        } else if (typeof Quagga !== 'undefined' && !Quagga.CameraAccess.getActiveStreamLabel()) {
            console.log("Quagga stop called, but no active stream was found.");
            $('#barcode-container').hide(); // Still hide the container
        }
    }


    $(document).ready(function () {
      itemAttachmentModalInstance = new bootstrap.Modal(document.getElementById('itemAttachmentModal'));

      // --- BG Removal Service Status Check (Example using abp) ---
      // This depends on your 'abp' object being available and configured.
      if (typeof abp !== 'undefined' && abp.services && abp.services.app && abp.services.app.bGRemoval) {
        var _bgService = abp.services.app.bGRemoval;
        _bgService.getQueueStatus().done(function (data) {
            if (data) {
                try {
                    var obj = JSON.parse(data); // Assuming data is a JSON string
                    var statusText = obj.status || "Unknown";
                    if (Number(obj.queue_num) < 1000) { // Example condition
                        $("#bgStatusBadge").removeClass("bg-info bg-danger").addClass("bg-success");
                        statusText = "Normal";
                        $("#bgremove").removeAttr("disabled");
                    } else {
                        $("#bgStatusBadge").removeClass("bg-info bg-success").addClass("bg-danger");
                        statusText = "Offline, Try Later";
                        $("#bgremove").prop("disabled", true);
                    }
                    $("#bgStatusBadge").text(
                        (obj.queue_num || 'N/A') + " items / " + (obj.queue_time || 'N/A') + "s (" + statusText + ")"
                    );
                } catch (e) {
                    console.error("Error parsing BG service status:", e);
                    $("#bgStatusBadge").text("Error parsing status").removeClass("bg-info").addClass("bg-warning");
                }
            } else {
                 $("#bgStatusBadge").text("No status data").removeClass("bg-info").addClass("bg-warning");
            }
        }).fail(function(jqXHR, textStatus, errorThrown) {
            console.error("Failed to get BG service status:", textStatus, errorThrown);
            $("#bgStatusBadge").text("Failed to get status").removeClass("bg-info").addClass("bg-danger");
            $("#bgremove").prop("disabled", true); // Disable processing if status fails
        });
      } else {
        console.warn("ABP BG Removal service object ('abp.services.app.bGRemoval') not available. BG Status check skipped.");
        $("#bgStatusBadge").text("BG Service N/A").removeClass("bg-info").addClass("bg-secondary");
        // Decide if #bgremove should be disabled or not if the service check can't run.
        // $("#bgremove").prop("disabled", true); // Optionally disable if status is critical
      }

      // --- Tab functionality for modal ---
      $('.modal-tab-trigger').click(function (e) {
          e.preventDefault();
          var tabsContainerSelector = $(this).data('tabs');
          var targetTabSelector = $(this).data('tab');

          $(tabsContainerSelector).find(".gtab").removeClass("active");
          $(tabsContainerSelector).find(targetTabSelector).addClass("active");

          // Sync button active states
          $(this).closest('.button-container').find('.modal-tab-trigger')
              .removeClass('btn-info styled-button styled-button-active') // styled-button-active if you have one
              .addClass('btn-light styled-button-light');
          $(this).removeClass('btn-light styled-button-light')
              .addClass('btn-info styled-button styled-button-active'); // styled-button-active if you have one

          if (targetTabSelector === ".modaltab-1") { // Scan tab
              $('#barcode-container').hide(); // Hide scanner initially, show on "Activate"
              // Don't stop scanner here, let btnModalScanStart handle init/start
          } else { // Type tab
              stopQuaggaScanner(); // Stop scanner if user switches to type tab
              $('#barcode-container').hide();
          }
      });
      // Initialize default active tab button style for modal (Scan button)
      $('#modalScanBtn').removeClass('btn-light styled-button-light')
                        .addClass('btn-info styled-button styled-button-active');
      $('#modalTypeBtn').removeClass('btn-info styled-button styled-button-active')
                        .addClass('btn-light styled-button-light');


      // --- Client-side image compression using Compressor.js ---
      // This attaches to the main file input. If you add more file inputs, consider specificity.
      $('#imageFiles').on('change', function (e) {
        console.log('Compressor.js: Main image file input changed. Compressing images...');
        var input = this;
        var files = Array.from(input.files);
        if (!files.length) return;

        let processedFilesArray = new Array(files.length); // Use array to maintain order
        let processedCount = 0;
        const originalFileCount = files.length;

        // Show some indicator to the user
        // Example: $('#compressionProgress').text(`Compressing 0/${originalFileCount}...`).show();

        files.forEach((file, index) => {
            if (!file.type.startsWith('image/')) {
                processedFilesArray[index] = file; // Keep non-images as is
                processedCount++;
                if (processedCount === originalFileCount) finalizeProcessedFiles();
                return;
            }
            new Compressor(file, {
                quality: 0.75, // Adjust as needed
                maxWidth: 2048,
                maxHeight: 2048,
                mimeType: 'image/jpeg', // Force jpeg for consistency, or use auto
                // checkOrientation: true, // Already default
                success(result) {
                    // Compressor.js might return a Blob, ensure it's a File object for DataTransfer
                    const newFileName = file.name.substring(0, file.name.lastIndexOf('.')) + '.jpg'; // If forcing jpeg
                    const newFile = new File([result], result.name || newFileName , { // Use result.name if available
                        type: result.type, // Use result.type
                        lastModified: Date.now()
                    });
                    processedFilesArray[index] = newFile;
                    processedCount++;
                    // $('#compressionProgress').text(`Compressing ${processedCount}/${originalFileCount}...`);
                    if (processedCount === originalFileCount) finalizeProcessedFiles();
                },
                error(err) {
                    console.error('Compressor.js Error on file', file.name, ':', err.message);
                    processedFilesArray[index] = file; // Keep original on error
                    processedCount++;
                    // $('#compressionProgress').text(`Compressing ${processedCount}/${originalFileCount}...`);
                    if (processedCount === originalFileCount) finalizeProcessedFiles();
                }
            });
        });

        function finalizeProcessedFiles() {
            var dt = new DataTransfer();
            processedFilesArray.forEach(f => { if(f) dt.items.add(f); });
            input.files = dt.files; // Update the file input
            console.log('Compressor.js: Processing complete. Files in input:', Array.from(dt.files).map(f=>f.name + " (" + Math.round(f.size/1024) + "KB)"));
            // $('#compressionProgress').text('Compression complete!').fadeOut(2000);
        }
      });

      // --- Load existing states and sort on page load ---
      getStoredJobIds(ASSOCIATED_JOB_IDS_KEY).forEach(jobId => applyCardState(jobId));
      getStoredJobIds(TRASHED_JOB_IDS_KEY).forEach(jobId => applyCardState(jobId));
      sortImageCards(); // Initial sort


      // --- Batch BG Removal Form Submission (#uploadForm) ---
      $("#uploadForm").on("submit", function (e) {
        e.preventDefault();
        const files = $("#imageFiles")[0].files;
        const model = $("#modelSelect").val();
        const postProcess = $("#postProcessCheck").is(":checked");

        if (files.length === 0) {
          alert("Please select image files.");
          return;
        }
        $("#bgremove").prop("disabled", true).text("Processing..."); // Disable button during submission

        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          const formData = new FormData();
          formData.append("image_file", file);
          formData.append("api_key", apiKey); // Ensure apiKey is defined globally
          formData.append("model", model);
          formData.append("post_process", postProcess.toString()); // Send as string true/false

          const originalFileName = file.name;
          const tempJobId = `temp-${Date.now()}-${i}`;
          const tempSelectAttachId = `select-attach-${tempJobId}`;
          const tempRadioName = `image_choice_${tempJobId}`;

          // Create card HTML
          const cardHtml = `
          <div class="col-md-4 image-card" id="card-${tempJobId}" data-job-id="${tempJobId}" data-original-filename="${originalFileName}">
            <div class="card">
              <div class="beerslider-wrapper-container img-placeholder">Awaiting submission...</div>
              <div class="card-body">
                <h5 class="card-title small" title="${originalFileName}">${originalFileName.length > 30 ? originalFileName.substring(0,27)+'...' : originalFileName}</h5>
                <div class="progress mb-2" style="height: 10px;"><div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 10%"></div></div>
                <p class="card-text status-text"><span class="badge bg-secondary status-badge">Submitting...</span></p>
                <p class="small text-muted job-id-text">Job ID: Pending...</p>
                <div class="form-check">
                  <input class="form-check-input image-select-radio" type="radio" name="${tempRadioName}" value="original" data-url="" id="${tempRadioName}_original">
                  <label class="form-check-label small" for="${tempRadioName}_original">Use Original</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input image-select-radio" type="radio" name="${tempRadioName}" value="processed" data-url="" id="${tempRadioName}_processed" checked>
                  <label class="form-check-label small" for="${tempRadioName}_processed">Use Processed</label>
                </div>
                <div class="form-check mt-2">
                    <input class="form-check-input select-for-attachment" type="checkbox" id="${tempSelectAttachId}">
                    <label class="form-check-label small" for="${tempSelectAttachId}">Select for Item Attachment</label>
                </div>
                <div class="mt-1">
                    <span class="badge bg-primary me-1 marker-badge associated-marker" style="display: none;">✅ Associated</span>
                    <span class="badge bg-warning text-dark marker-badge trashed-marker" style="display: none;">🗑️ Trashed</span>
                </div>
              </div>
              <div class="card-footer">
                <button class="btn btn-sm btn-outline-secondary refresh-btn" data-jobid="${tempJobId}" disabled title="Re-check status or re-process">
                    <i class="fas fa-sync-alt"></i> Re-check
                </button>
                <i class="fas fa-trash-alt trash-btn" data-jobid="${tempJobId}" title="Move to Trashed"></i>
              </div>
            </div>
          </div>`;
          const $card = $(cardHtml);
          $("#results").prepend($card); // Prepend to show newest first before sorting
          jobFileMap[tempJobId] = file; // Store file against temp ID for potential re-process

          $.ajax({
            url: submitApiUrl,
            method: "POST",
            data: formData,
            processData: false,
            contentType: false,
            success: function (data) {
              if (data.job_id) {
                const realJobId = data.job_id;
                delete jobFileMap[tempJobId]; // Remove temp entry
                jobFileMap[realJobId] = file;  // Add file against real job ID

                // Update card with real Job ID
                $card.attr("id", `card-${realJobId}`).data("job-id", realJobId);
                $card.find(".job-id-text").text(`Job ID: ${realJobId}`);
                $card.find(".refresh-btn").data("jobid", realJobId).prop("disabled", true); // Disabled until processing starts
                $card.find(".trash-btn").data("jobid", realJobId);

                // Update radio button names and labels for unique IDs
                const realRadioName = `image_choice_${realJobId}`;
                $card.find(`input[name="${tempRadioName}"]`).attr("name", realRadioName);
                $card.find(`label[for="${tempRadioName}_original"]`).attr("for", `${realRadioName}_original`);
                $card.find(`input#${tempRadioName}_original`).attr("id", `${realRadioName}_original`);
                $card.find(`label[for="${tempRadioName}_processed"]`).attr("for", `${realRadioName}_processed`);
                $card.find(`input#${tempRadioName}_processed`).attr("id", `${realRadioName}_processed`);

                const $selectAttachInput = $card.find(`#${tempSelectAttachId}`);
                const newSelectAttachId = `select-attach-${realJobId}`;
                $selectAttachInput.attr('id', newSelectAttachId).next('label').attr('for', newSelectAttachId);

                // Store original image URL (assuming API returns it on submit)
                $card.data("original-url", data.original_image_url); // Critical for BeerSlider
                $card.find(`input[name="${realRadioName}"][value="original"]`).data("url", data.original_image_url);
                // Initial placeholder for slider before polling gives processed URL
                $card.find(".beerslider-wrapper-container.img-placeholder").html(`Original: ${data.original_image_url ? 'OK' : 'Missing'}<br>Processed: ${data.status || 'Queued'}`);

                pollStatus(realJobId, $card[0]);
                applyCardState(realJobId); // Apply any stored state (e.g. if it was previously trashed by this ID)
                sortImageCards();
              } else {
                console.error("Submission successful but no job_id received for file:", originalFileName, data);
                $card.find(".status-text").html('<span class="badge bg-danger status-badge">❌ Error</span>: No Job ID from server');
                $card.find(".progress-bar").addClass("bg-danger").css("width", "100%");
                $card.find(".refresh-btn").prop("disabled", false); // Allow re-submission attempt
              }
            },
            error: function (xhr, status, error) {
              console.error("Submission AJAX failed for file:", originalFileName, status, error, xhr.responseText);
              $card.find(".status-text").html(`<span class="badge bg-danger status-badge">❌ Error</span>: ${xhr.statusText || 'Submission Failed'}`);
              $card.find(".progress-bar").addClass("bg-danger").css("width", "100%");
              $card.find(".refresh-btn").data("jobid", tempJobId).prop("disabled", false); // Allow re-submission of this card
            },
            complete: function() {
                // Re-enable form submit button if all files are processed
                if (i === files.length - 1) {
                    $("#bgremove").prop("disabled", false).text("Process Selected Images");
                }
            }
          });
        }
        $("#imageFiles").val(""); // Clear file input after starting uploads
        updateAttachButtonStatus();
      });


      // --- Event Handlers for Card Actions (Refresh, Trash, Select) ---
      $("#results").on("click", ".refresh-btn", function () {
          const jobId = $(this).data("jobid");
          const $card = $(`#card-${jobId}`);
          if (!$card.length) return;

          console.log("Re-checking status for job:", jobId);
          $card.find(".status-text").html('<span class="badge bg-info text-dark status-badge">🔄 Re-checking...</span>');
          $card.find(".progress-bar").removeClass("bg-danger bg-success bg-warning").addClass("progress-bar-striped progress-bar-animated").css("width", "25%");
          $(this).prop("disabled", true); // Disable button while re-checking
          pollStatus(jobId, $card[0]); // Call pollStatus directly
          // If you want full re-process (new job ID), that's more complex:
          // 1. Get original file (from jobFileMap[jobId])
          // 2. Create new FormData
          // 3. AJAX POST to submitApiUrl
          // 4. On success, update the card with the *new* job_id and re-poll.
      });

      $("#results").on("click", ".trash-btn", function () {
        const jobId = $(this).data("jobid");
        if (!jobId || String(jobId).startsWith('temp-')) return; // Don't trash temp cards

        const $card = $(`#card-${jobId}`);
        const isCurrentlyTrashed = isJobTrashed(jobId);

        if (isCurrentlyTrashed) {
            removeJobIdFromStorage(TRASHED_JOB_IDS_KEY, jobId);
            $(this).attr('title', 'Move to Trashed').removeClass('text-success').addClass('fa-trash-alt'); // Reset icon if changed
            $card.find('.select-for-attachment').prop('disabled', false);
        } else {
            addJobIdToStorage(TRASHED_JOB_IDS_KEY, jobId);
            removeJobIdFromStorage(ASSOCIATED_JOB_IDS_KEY, jobId); // Cannot be associated and trashed
            $(this).attr('title', 'Restore from Trashed').removeClass('fa-trash-alt').addClass('text-success'); // Indicate can restore
            $card.find('.select-for-attachment').prop('checked', false).prop('disabled', true);
        }
        applyCardState(jobId);
        sortImageCards();
        updateAttachButtonStatus();
      });

      $("#results").on("change", ".select-for-attachment", function () {
          updateAttachButtonStatus();
      });
      $("#results").on("change", ".image-select-radio", function() {
        // Potentially update something if the user changes original/processed choice
        // For now, this is mainly used when preparing for attachment
        console.log("Image choice changed for job:", $(this).attr('name').replace('image_choice_',''), "to:", $(this).val());
      });


      // --- "Attach Selected to Item" Button & Modal Logic ---
      $("#attachImagesButton").on("click", function () {
        const $selectedCheckboxes = $('#results .image-card:not(.trashed-card) .select-for-attachment:checked');
        if ($selectedCheckboxes.length === 0) {
          alert("Please select at least one processed image for attachment.");
          return;
        }

        const $thumbnailsContainer = $("#selectedImagesThumbnailsContainer").empty();
        $("#modalAlertPlaceholder").empty();
        $('#itemAttachmentForm')[0].reset(); // Reset form fields in modal
        $('#barcode-result').text("Waiting for scan...");
        $('#modalItemNumber').val('');
        // Reset modal tabs to default (Scan active)
        $('#modalScanBtn').trigger('click');
        stopQuaggaScanner(); // Ensure scanner is off when modal opens initially

        let imagesAdded = 0;
        $selectedCheckboxes.each(function () {
          const $card = $(this).closest(".image-card");
          const jobId = $card.data("job-id");
          const originalFileName = $card.data("original-filename");
          const selectedVersionRadio = $card.find(`input[name="image_choice_${jobId}"]:checked`);
          const selectedVersion = selectedVersionRadio.val(); // "original" or "processed"
          let imageUrl = selectedVersionRadio.data("url");

          // Sanity check: if processed is selected but URL is missing, try original.
          if (selectedVersion === "processed" && (!imageUrl || imageUrl.trim() === "")) {
              console.warn(`Processed image URL missing for ${jobId}, trying original.`);
              const originalUrl = $card.find(`input[name="image_choice_${jobId}"][value="original"]`).data("url");
              if (originalUrl && originalUrl.trim() !== "") {
                  imageUrl = originalUrl;
                  // alert(`Warning: Processed image for "${originalFileName}" was not available. Using original.`);
              } else {
                  console.error(`Both processed and original URLs missing for ${jobId}. Skipping.`);
                  return; // Skip this image
              }
          }


          if (jobId && !String(jobId).startsWith("temp-") && imageUrl && imageUrl.trim() !== "") {
            const thumbHtml = `
              <div class="modal-thumbnail-item" data-job-id="${jobId}" data-image-url="${imageUrl}" data-version="${selectedVersion}" data-original-filename="${originalFileName}">
                <img src="${imageUrl}" alt="${originalFileName}" title="${originalFileName} (version: ${selectedVersion})">
                <button type="button" class="remove-img-btn" title="Remove this image from attachment list">×</button>
              </div>`;
            $thumbnailsContainer.append(thumbHtml);
            imagesAdded++;
          } else {
            console.warn("Skipping image for attachment due to missing Job ID or Image URL:", originalFileName, "Job ID:", jobId, "URL:", imageUrl);
          }
        });

        if (imagesAdded > 0) {
            itemAttachmentModalInstance.show();
        } else {
             alert("None of the selected images are ready for attachment or have valid URLs. Please ensure processing is complete and URLs are available.");
        }
      });

      // Remove image from modal thumbnail view
      $("#selectedImagesThumbnailsContainer").on("click", ".remove-img-btn", function() {
          $(this).closest(".modal-thumbnail-item").remove();
          if ($("#selectedImagesThumbnailsContainer .modal-thumbnail-item").length === 0) {
              // Optionally close modal or show message if all images removed
              // itemAttachmentModalInstance.hide();
              // alert("All images removed. Closing attachment window.");
          }
      });

      // Activate barcode scanner button in modal
      $('#btnModalScanStart').on('click', function() {
          $('#barcode-result').text("Activating scanner..."); // Give user feedback
          initQuaggaScanner();
      });

      // Stop scanner when modal is hidden (Bootstrap event)
      $('#itemAttachmentModal').on('hidden.bs.modal', function () {
          stopQuaggaScanner();
      });


      // --- Modal Form Submission (E-commerce form + selected images) ---
      $("#itemAttachmentForm").on("submit", function(e) {
        e.preventDefault();
        $("#modalAlertPlaceholder").empty().removeClass('alert alert-danger alert-success'); // Clear previous alerts

        const itemNumber = $("#modalItemNumber").val().trim();
        $('#finalItemNumberForSubmission').val(itemNumber);

        // Basic validation (add more as needed for other fields)
        if (!itemNumber) {
          $("#modalAlertPlaceholder").html('<div class="alert alert-danger" role="alert">Item Number is required. Please scan or type it.</div>');
          $('#modalItemNumber').focus();
          return;
        }
        if ($("#selectedImagesThumbnailsContainer .modal-thumbnail-item").length === 0) {
            $("#modalAlertPlaceholder").html('<div class="alert alert-danger" role="alert">No images are selected for attachment.</div>');
            return;
        }

        const attachedImages = [];
        $("#selectedImagesThumbnailsContainer .modal-thumbnail-item").each(function() {
            const $thumb = $(this);
            attachedImages.push({
                job_id: $thumb.data("job-id"),
                image_url: $thumb.data("image-url"), // This should be the URL of the image (original or processed)
                version_selected: $thumb.data("version"), // "original" or "processed"
                original_filename: $thumb.data("original-filename") || $thumb.find('img').attr('alt')
            });
        });

        const formData = new FormData(this); // `this` is the form element, collects all named fields
        // The hidden input finalItemNumberForSubmission is already included by new FormData(this) if it has a name.
        // formData.append("finalItemNumberForSubmission", itemNumber); // Already in form, or ensure #modalItemNumber has name="finalItemNumberForSubmission"
        // Append other fields if they are not part of the form's named inputs
        // formData.append("title", $("#modalTitle").val().trim()); // ... and so on for all fields

        if (attachedImages.length > 0) {
            formData.append("attached_images_json", JSON.stringify(attachedImages));
        } else {
            formData.append("attached_images_json", "[]"); // Should not happen due to check above
        }

        // Log FormData for debugging
        console.log("FormData being sent to associateApiUrl:", associateApiUrl);
        for (let pair of formData.entries()) {
            console.log(pair[0] + ': ' + pair[1]);
        }
        const submitButton = $(this).find('button[type="submit"]');
        const originalButtonText = submitButton.html();
        submitButton.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Submitting...');


        $.ajax({
           url: associateApiUrl,
           method: "POST",
           data: formData,
           processData: false,
           contentType: false,
           success: function(response) {
             console.log("Item & Image Association successful:", response);
             const submittedItemNumber = itemNumber; // From form submission start
             const jobIdsMarked = [];

             attachedImages.forEach(img => {
                addJobIdToStorage(ASSOCIATED_JOB_IDS_KEY, img.job_id);
                removeJobIdFromStorage(TRASHED_JOB_IDS_KEY, img.job_id); // Untrash if it was trashed
                applyCardState(img.job_id); // Update card UI
                $(`#card-${img.job_id} .select-for-attachment`).prop('checked', false); // Uncheck from main list
                jobIdsMarked.push(img.job_id);
             });

             itemAttachmentModalInstance.hide();
             sortImageCards();
             updateAttachButtonStatus();

             // Show success message (e.g., using a more persistent notification system or alert)
             alert(`Item "${$('#modalTitle').val()}" (Number: ${submittedItemNumber}) and ${jobIdsMarked.length} image(s) submitted/associated successfully!`);
             // Or use a dedicated notification area on the main page:
             // $('#mainPageNotificationArea').html(`<div class="alert alert-success">...</div>`).show().delay(5000).fadeOut();
           },
           error: function(xhr) {
             let errorMsg = "Failed to submit item and associate images.";
             console.error("Association AJAX Error:", xhr.status, xhr.statusText, xhr.responseText);
             if (xhr.responseJSON && xhr.responseJSON.error) { // If server sends JSON error
                 errorMsg = xhr.responseJSON.error;
             } else if (xhr.responseText) {
                 try { // Try to parse if it's structured error (like ASP.NET Core problem details)
                     const errData = JSON.parse(xhr.responseText);
                     if (errData.detail) errorMsg = errData.detail;
                     else if (errData.title) errorMsg = errData.title;
                     else if (typeof xhr.responseText === 'string' && xhr.responseText.length < 300) errorMsg = xhr.responseText; // Short text error
                 } catch (e) { /* Not JSON */ }
             }
             errorMsg += ` (Status: ${xhr.status} ${xhr.statusText})`;
             $("#modalAlertPlaceholder").html(`<div class="alert alert-danger" role="alert">${errorMsg}</div>`);
           },
           complete: function() {
                submitButton.prop('disabled', false).html(originalButtonText);
           }
        });
    }); // End of $("#itemAttachmentForm").on("submit", ...)


      // --- Mock/Placeholder functions for external scripts if not fully loaded/available ---
      // These should ideally be defined in your resale.one JS files.
      if (typeof window.scanActive !== 'function') { window.scanActive = function() { console.log("Mock: scanActive called.");}; }
      if (typeof window.typeActive !== 'function') { window.typeActive = function() { console.log("Mock: typeActive called.");}; }
      if (typeof window.disableScan !== 'function') { window.disableScan = function() { console.log("Mock: disableScan called.");}; }
      if (typeof window.LookupItem !== 'function') {
          window.LookupItem = function() {
            const itemNum = $('#modalItemNumber').val();
            console.log("Mock: LookupItem called for item: " + itemNum);
            $('#modalItemLoading').show();
            // Simulate API call for lookup
            setTimeout(() => {
               if (itemNum === "12345") {
                   $('#modalTitle').val("Mocked Item: Widget");
                   $('#modalPrice').val("$25.00");
                   $('#modalPriceWithSurcharge').val("$29.99");
                   $('#modalDescription').val("This is a super widget, looked up via mock function.");
                   $('#modalCondition').val("LIKE NEW");
               } else {
                   $('#modalTitle').val(""); // Clear fields if not found
                   $('#modalPrice').val("");
                   $('#modalPriceWithSurcharge').val("");
                   $('#modalDescription').val("Item not found in mock lookup.");
               }
               $('#modalItemLoading').hide();
               // Show message in modal if item not found
               if (itemNum !== "12345") {
                   $("#modalAlertPlaceholder").html('<div class="alert alert-warning" role="alert">Item ' + itemNum + ' not found (mock data).</div>');
               } else {
                   $("#modalAlertPlaceholder").empty();
               }
            }, 1200);
          };
      }
      if (typeof window.CurrencyFormatted !== 'function') {
          window.CurrencyFormatted = function(inputElement) {
            console.log("Mock: CurrencyFormatted called for input:", inputElement.id);
            // Basic mock: ensure $ and two decimal places
            let value = $(inputElement).val().replace(/[^\d.]/g, '');
            if (value.startsWith('.')) value = "0" + value;
            let num = parseFloat(value);
            if (!isNaN(num)) {
                $(inputElement).val('$' + num.toFixed(2));
            } else if ($(inputElement).val().trim() !== "" && $(inputElement).val().trim() !== "$") {
                 // $(inputElement).val(''); // Clear if invalid and not empty
            }
          };
          // Attach to price fields for auto-formatting (simple version)
          $('#modalPrice, #modalPriceWithSurcharge, #modalNewPrice').on('blur', function() {
              CurrencyFormatted(this);
          });
      }
      if (typeof window.startScanner !== 'function') { // This was for a main page scanner
          window.startScanner = function() {
              console.log("Mock: startScanner (main page) called. Modal uses its own activation.");
          };
      }

      // --- Event handler for modal item lookup button ---
      $('#btnModalLookup').on('click', function() {
          if (typeof LookupItem === "function") {
              const itemNum = $('#modalItemNumber').val();
              if (itemNum && itemNum.trim() !== "") {
                $("#modalAlertPlaceholder").empty(); // Clear previous alerts
                $('#modalItemLoading').show();
                LookupItem(); // Assumes LookupItem uses value from #modalItemNumber and handles UI updates
              } else {
                $("#modalAlertPlaceholder").html('<div class="alert alert-warning" role="alert">Please enter an item number to lookup.</div>');
                $('#modalItemNumber').focus();
              }
          } else {
              console.warn("LookupItem function not defined. Cannot perform lookup in modal.");
              $("#modalAlertPlaceholder").html('<div class="alert alert-danger" role="alert">Lookup functionality is currently unavailable.</div>');
          }
      });

    }); // End $(document).ready
  </script>
</body>
</html>
