<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Batch Background Removal (BeerSlider.js)</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <!-- Add Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/beerslider/dist/BeerSlider.css"
  />
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <style>
    .image-card {
      margin-bottom: 20px;
      transition: opacity 0.3s ease-in-out; /* For visual feedback on trashing */
    }
    .image-card.trashed-card {
        opacity: 0.6; /* Visually indicate trashed */
    }
    .beerslider-wrapper-container {
      width: 100%;
      aspect-ratio: 1 / 1;
      border: 1px solid #ccc;
      position: relative;
    }
    .beerslider-wrapper-container.img-placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background-color: #f0f0f0;
      color: #aaa;
      font-size: 0.9em;
      text-align: center;
      height: 100%;
    }
    .beer-slider img {
      display: block;
      max-width: 100%;
      height: auto;
      object-fit: contain;
    }
    .status-badge, .marker-badge {
      font-size: 0.8em;
    }
    .card-footer {
      background-color: #f8f9fa;
      display: flex;
      justify-content: space-between; /* Align reprocess and trash */
      align-items: center;
    }
    .trash-btn {
        color: #dc3545; /* Bootstrap danger color */
        cursor: pointer;
    }
    .trash-btn:hover {
        color: #bd2130;
    }
  </style>
</head>
<body class="bg-light">
  <div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1>Batch Image Background Removal</h1>
    </div>

    <form id="uploadForm" class="mb-4">
      <div class="mb-3">
        <label for="imageFiles" class="form-label"
          >Select Images (PNG, JPG, WebP):</label
        >
        <input
          type="file"
          class="form-control"
          id="imageFiles"
          multiple
          accept="image/png, image/jpeg, image/webp"
        />
      </div>
      <div class="row">
        <div class="col-md-4 mb-3">
          <label for="modelSelect" class="form-label">Model:</label>
          <select id="modelSelect" class="form-select">
            <option value="u2net" selected>U2Net (General Purpose)</option>
            <option value="u2netp">U2Netp (Lightweight)</option>
            <option value="u2net_human_seg">U2Net Human Segmentation</option>
            <option value="u2net_cloth_seg">U2Net Cloth Segmentation</option>
            <option value="silueta">Silueta (Alternative to U2Net)</option>
            <option value="isnet-general-use">IS-Net General Use</option>
            <option value="isnet-anime">IS-Net Anime</option>
          </select>
        </div>
        <div class="col-md-4 mb-3 d-flex align-items-end">
          <div class="form-check">
            <input
              class="form-check-input"
              type="checkbox"
              id="postProcessCheck"
            />
            <label class="form-check-label" for="postProcessCheck">
              Enable Post-Processing (Alpha Matting)
            </label>
          </div>
        </div>
        <div class="col-md-4 mb-3 d-flex align-items-end">
          <button type="submit" class="btn btn-primary w-100">
            Process Selected Images
          </button>
        </div>
      </div>
    </form>

    <hr />

    <div id="attachButtonContainer" class="mb-3 text-end" style="display: none;">
        <button id="attachImagesButton" class="btn btn-info btn-lg" disabled>
            Attach Selected to Item
        </button>
    </div>

    <div id="results" class="row mt-4">
      <!-- Image cards will be appended here -->
    </div>
  </div>

  <!-- Item Attachment Modal -->
  <div class="modal fade" id="itemAttachmentModal" tabindex="-1" aria-labelledby="itemAttachmentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="itemAttachmentModalLabel">Attach Images to Item</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <h6>Selected Images for Attachment:</h6>
          <ul id="selectedImagesListModal" class="list-group mb-3"></ul>
          <form id="itemAttachmentForm">
            <div class="mb-3">
              <label for="itemNumberInput" class="form-label">Item Number:</label>
              <input type="text" class="form-control" id="itemNumberInput" required>
            </div>
            <div id="modalAlertPlaceholder"></div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary" form="itemAttachmentForm">Submit to Item</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/beerslider/dist/BeerSlider.min.js"></script>

  <script>
    const submitApiUrl = "/submit";
    const statusApiUrl = "/status/";
    const associateApiUrl = "/api/v1/item/associate_images"; // Backend endpoint for item association
    const apiKey = "secretApiKey"; // IMPORTANT: Replace with secure handling

    const ASSOCIATED_JOB_IDS_KEY = 'batchUploader_associatedJobIds';
    const TRASHED_JOB_IDS_KEY = 'batchUploader_trashedJobIds';

    let jobFileMap = {};
    let sliderInstances = {};
    let itemAttachmentModalInstance;

    // --- LocalStorage Helpers ---
    function getStoredJobIds(key) {
        const stored = localStorage.getItem(key);
        return stored ? JSON.parse(stored) : [];
    }
    function addJobIdToStorage(key, jobId) {
        let currentJobIds = getStoredJobIds(key);
        if (jobId && !currentJobIds.includes(jobId)) { // Ensure jobId is valid
            currentJobIds.push(jobId);
            localStorage.setItem(key, JSON.stringify(currentJobIds));
        }
    }
    function removeJobIdFromStorage(key, jobId) {
        let currentJobIds = getStoredJobIds(key);
        if (jobId) { // Ensure jobId is valid
            const index = currentJobIds.indexOf(jobId);
            if (index > -1) {
                currentJobIds.splice(index, 1);
                localStorage.setItem(key, JSON.stringify(currentJobIds));
            }
        }
    }
    function isJobAssociated(jobId) {
        return jobId ? getStoredJobIds(ASSOCIATED_JOB_IDS_KEY).includes(jobId) : false;
    }
    function isJobTrashed(jobId) {
        return jobId ? getStoredJobIds(TRASHED_JOB_IDS_KEY).includes(jobId) : false;
    }

    // --- UI Update & Sorting Functions ---
    function updateAttachButtonStatus() {
      const anyCardsPresent = $('#results .image-card').length > 0;
      const $attachButtonContainer = $("#attachButtonContainer");
      const $attachButton = $("#attachImagesButton");

      if (anyCardsPresent) {
        $attachButtonContainer.show();
        const anySelectedForAttachment = $('#results .image-card:not(.trashed-card) .select-for-attachment:checked').length > 0;
        $attachButton.prop("disabled", !anySelectedForAttachment);
      } else {
        $attachButtonContainer.hide();
        $attachButton.prop("disabled", true);
      }
    }

    function applyCardState(jobId) {
        const $card = $(`#card-${jobId}`);
        if (!$card.length || !jobId) return; // Ensure card and jobId exist

        const associated = isJobAssociated(jobId);
        const trashed = isJobTrashed(jobId);

        $card.find('.associated-marker').toggle(associated && !trashed);
        $card.find('.trashed-marker').toggle(trashed);
        $card.toggleClass('trashed-card', trashed);

        $card.find('.select-for-attachment').prop('disabled', trashed);
        if (trashed) {
            $card.find('.select-for-attachment').prop('checked', false);
        }
    }

    function sortImageCards() {
        const $resultsContainer = $("#results");
        const $cards = $resultsContainer.children(".image-card").get();

        $cards.sort(function(a, b) {
            const $a = $(a);
            const $b = $(b);
            const aJobId = $a.data('job-id');
            const bJobId = $b.data('job-id');

            // Temp cards (no final job-id yet) should ideally stay at top or be handled by initial prepend
            if (!aJobId || aJobId.startsWith('temp-')) return -1;
            if (!bJobId || bJobId.startsWith('temp-')) return 1;

            const aTrashed = isJobTrashed(aJobId);
            const bTrashed = isJobTrashed(bJobId);
            const aAssociated = isJobAssociated(aJobId);
            const bAssociated = isJobAssociated(bJobId);

            if (aTrashed && !bTrashed) return 1;  // a (trashed) to bottom
            if (!aTrashed && bTrashed) return -1; // b (trashed) to bottom
            if (aTrashed && bTrashed) { // Both trashed, sort by name
                 return ($a.data('original-filename') || '').localeCompare($b.data('original-filename') || '');
            }

            // Neither is trashed, sort by association
            if (aAssociated && !bAssociated) return 1; // a (associated) after b (not associated)
            if (!aAssociated && bAssociated) return -1; // b (associated) after a (not associated)

            // If same association & trashed status, sort by original filename
            return ($a.data('original-filename') || '').localeCompare($b.data('original-filename') || '');
        });

        $.each($cards, function(idx, itm) { $resultsContainer.append(itm); });
        updateAttachButtonStatus();
    }

    function initializeOrUpdateBeerSlider($card, originalImageUrl, processedImageUrl) {
      const $sliderWrapper = $card.find('.beerslider-wrapper-container');
      const originalFileName = $card.data('original-filename');
      const jobId = $card.data('job-id');
      if (!jobId) {
          console.error("Cannot initialize BeerSlider: missing job-id on card.");
          return;
      }
      const sliderContainerId = 'beer-slider-' + jobId.replace(/-/g, '');

      if (sliderInstances[sliderContainerId]) {
          // BeerSlider doesn't have a documented public destroy. Clearing and rebuilding.
      }
      $sliderWrapper.removeClass('img-placeholder').empty();

      const $beerSliderDiv = $('<div>').attr('id', sliderContainerId).addClass('beer-slider');
      const $beforeImgTag = $('<img>').attr('src', originalImageUrl).attr('alt', 'Original: ' + originalFileName);
      const $beerRevealDiv = $('<div>').addClass('beer-reveal');
      const $afterImgTag = $('<img>').attr('src', processedImageUrl + `?t=${new Date().getTime()}`).attr('alt', 'Processed: ' + originalFileName);

      $beerRevealDiv.append($afterImgTag);
      $beerSliderDiv.append($beforeImgTag).append($beerRevealDiv);
      $sliderWrapper.append($beerSliderDiv);

      let imagesLoaded = 0;
      const totalImages = 2;

      function onImageLoad() {
          imagesLoaded++;
          if (imagesLoaded === totalImages) {
              try {
                  if (window.BeerSlider) {
                      const sliderElement = document.getElementById(sliderContainerId);
                      if (sliderElement) {
                          const instance = new BeerSlider(sliderElement, { start: 50 });
                          sliderInstances[sliderContainerId] = instance;
                      } else {
                          console.error("BeerSlider target element not found:", sliderContainerId);
                          $sliderWrapper.addClass('img-placeholder').text('Slider DOM error.');
                      }
                  } else {
                       console.warn("BeerSlider library not found on window.");
                       $sliderWrapper.addClass('img-placeholder').text('Slider library error.');
                  }
              } catch (e) {
                  console.error("Error initializing BeerSlider for #" + sliderContainerId + ":", e);
                  $sliderWrapper.addClass('img-placeholder').text('Error initializing slider.');
              }
          }
      }
      $beforeImgTag.on('load', onImageLoad).on('error', () => {
          console.error('Error loading original image for BeerSlider:', originalImageUrl);
          $sliderWrapper.addClass('img-placeholder').text('Error loading original image.');
      });
      $afterImgTag.on('load', onImageLoad).on('error', () => {
          console.error('Error loading processed image for BeerSlider:', processedImageUrl);
          $sliderWrapper.addClass('img-placeholder').text('Error loading processed image.');
      });

      // Fallback for cached images
      setTimeout(() => {
          if (imagesLoaded < totalImages && !$sliderWrapper.hasClass('img-placeholder')) {
               if ($beforeImgTag.length && $beforeImgTag[0].complete && $afterImgTag.length && $afterImgTag[0].complete &&
                   $beforeImgTag[0].naturalWidth > 0 && $afterImgTag[0].naturalWidth > 0) {
                  if (imagesLoaded === 0) { onImageLoad(); onImageLoad(); }
                  else if (imagesLoaded === 1) { onImageLoad(); }
               }
          }
      }, 700);
    }

    function pollStatus(jobId, cardElement) {
      const $card = $(cardElement);
      const $statusText = $card.find(".status-text");
      const $progressBar = $card.find(".progress-bar");
      const $sliderWrapper = $card.find(".beerslider-wrapper-container");
      const $refreshButton = $card.find(".refresh-btn");
      const originalImageUrl = $card.data("original-url");

      $.getJSON(statusApiUrl + jobId, function (data) {
        $statusText.text(
          data.status.charAt(0).toUpperCase() +
            data.status.slice(1) +
            (data.eta > 0 ? ` (ETA: ${data.eta}s)` : "")
        );
        $refreshButton.prop("disabled", data.status === "processing" || data.status === "queued");

        if (data.status === "done") {
          $statusText.html('<span class="badge bg-success status-badge">✅ Done</span>');
          $progressBar.removeClass("progress-bar-striped progress-bar-animated").addClass("bg-success").css("width", "100%");
          if (data.processed_image_url && originalImageUrl) {
            initializeOrUpdateBeerSlider($card, originalImageUrl, data.processed_image_url);
          } else {
            $sliderWrapper.addClass("img-placeholder").text("Image URLs missing for slider.");
          }
          $card.data("processed-url", data.processed_image_url);
          $card.find(`input[name="image_choice_${jobId}"][value="processed"]`).data("url", data.processed_image_url);
          applyCardState(jobId);
          sortImageCards();
        } else if (data.status === "error") {
          $statusText.html(`<span class="badge bg-danger status-badge">❌ Error</span>: ${data.error_message || "Unknown error"}`);
          $progressBar.removeClass("progress-bar-striped progress-bar-animated").addClass("bg-danger").css("width", "100%");
          $sliderWrapper.addClass("img-placeholder").text("Processing Error: " + (data.error_message || "Unknown issue"));
          applyCardState(jobId);
          sortImageCards();
        } else if (data.status === "processing" || data.status === "queued") {
          $statusText.html(`<span class="badge bg-info text-dark status-badge">${data.status === "processing" ? "⚙️ Processing..." : "⏳ Queued..."}</span> (ETA: ${data.eta}s)`);
          $progressBar.addClass("progress-bar-striped progress-bar-animated").removeClass("bg-success bg-danger").css("width", "50%");
          setTimeout(() => pollStatus(jobId, cardElement), 2000);
        }
      }).fail(function () {
        $statusText.html('<span class="badge bg-danger status-badge">❌ Error</span>: Failed to get status');
        $progressBar.removeClass("progress-bar-striped progress-bar-animated").addClass("bg-danger").css("width", "100%");
        $sliderWrapper.addClass("img-placeholder").text("Status Check Failed.");
        $refreshButton.prop("disabled", false);
        applyCardState(jobId);
        sortImageCards();
      });
    }

    $(document).ready(function () {
      itemAttachmentModalInstance = new bootstrap.Modal(document.getElementById('itemAttachmentModal'));

      // Load existing states and sort on page load
      getStoredJobIds(ASSOCIATED_JOB_IDS_KEY).forEach(jobId => applyCardState(jobId)); // Apply for any cards that might be hardcoded or reloaded
      getStoredJobIds(TRASHED_JOB_IDS_KEY).forEach(jobId => applyCardState(jobId));
      sortImageCards(); // This also calls updateAttachButtonStatus

      $("#uploadForm").on("submit", function (e) {
        e.preventDefault();
        const files = $("#imageFiles")[0].files;
        const model = $("#modelSelect").val();
        const postProcess = $("#postProcessCheck").is(":checked");

        if (files.length === 0) { alert("Please select one or more image files."); return; }

        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          const formData = new FormData();
          formData.append("image_file", file);
          formData.append("api_key", apiKey);
          formData.append("model", model);
          formData.append("post_process", postProcess);

          const originalFileName = file.name;
          const tempJobId = `temp-${Date.now()}-${i}`; // Unique temporary ID
          const tempSelectAttachId = `select-attach-${tempJobId}`;

          const cardHtml = `
          <div class="col-md-4 image-card" id="card-${tempJobId}" data-original-filename="${originalFileName}">
            <div class="card">
              <div class="beerslider-wrapper-container img-placeholder">
                Original: Awaiting submission<br>Processed: Queued
              </div>
              <div class="card-body">
                <h5 class="card-title small">${originalFileName}</h5>
                <div class="progress mb-2" style="height: 10px;">
                  <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 10%"></div>
                </div>
                <p class="card-text status-text"><span class="badge bg-secondary status-badge">⏳ Submitting...</span></p>
                <p class="small text-muted job-id-text">Job ID: Pending...</p>
                <div class="form-check">
                  <input class="form-check-input image-select-radio" type="radio" name="image_choice_${tempJobId}" value="original" data-url="">
                  <label class="form-check-label small" for="image_choice_${tempJobId}_original">Use Original</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input image-select-radio" type="radio" name="image_choice_${tempJobId}" value="processed" data-url="" checked>
                  <label class="form-check-label small" for="image_choice_${tempJobId}_processed">Use Processed</label>
                </div>
                <div class="form-check mt-2">
                    <input class="form-check-input select-for-attachment" type="checkbox" value="" id="${tempSelectAttachId}">
                    <label class="form-check-label small" for="${tempSelectAttachId}">Select for Item Attachment</label>
                </div>
                <div class="mt-1">
                    <span class="badge bg-info me-1 marker-badge associated-marker" style="display: none;">Associated</span>
                    <span class="badge bg-secondary marker-badge trashed-marker" style="display: none;">Trashed</span>
                </div>
              </div>
              <div class="card-footer">
                <button class="btn btn-sm btn-outline-primary refresh-btn" data-jobid="${tempJobId}" disabled>Re-process</button>
                <i class="fas fa-trash-alt trash-btn" data-jobid="${tempJobId}" title="Move to bottom/ignore"></i>
              </div>
            </div>
          </div>`;
          const $card = $(cardHtml);
          $("#results").prepend($card);

          $.ajax({
            url: submitApiUrl, method: "POST", data: formData, processData: false, contentType: false,
            success: function (data) {
              if (data.job_id) {
                const realJobId = data.job_id;
                jobFileMap[realJobId] = file;

                // Update card with real job ID
                $card.attr("id", `card-${realJobId}`);
                $card.data("job-id", realJobId); // Critical for future operations
                $card.find(".job-id-text").text(`Job ID: ${realJobId}`);
                $card.find(".refresh-btn").data("jobid", realJobId).prop("disabled", true);
                $card.find(".trash-btn").data("jobid", realJobId);

                // Update radio button names
                $card.find(`input[name="image_choice_${tempJobId}"]`).attr("name", `image_choice_${realJobId}`);
                // Update select-for-attachment id and label's for
                const $selectAttachInput = $card.find(`#${tempSelectAttachId}`);
                const newSelectAttachId = `select-attach-${realJobId}`;
                $selectAttachInput.attr('id', newSelectAttachId);
                $selectAttachInput.next('label').attr('for', newSelectAttachId);
                // Update radio button labels' for attributes
                $card.find(`label[for="image_choice_${tempJobId}_original"]`).attr('for', `image_choice_${realJobId}_original`);
                $card.find(`label[for="image_choice_${tempJobId}_processed"]`).attr('for', `image_choice_${realJobId}_processed`);


                $card.data("original-url", data.original_image_url);
                $card.find(`input[name="image_choice_${realJobId}"][value="original"]`).data("url", data.original_image_url);

                $card.find(".beerslider-wrapper-container.img-placeholder")
                  .html(`Original: Waiting for server URL<br>Processed: ${data.status === "queued" ? "Queued" : "Processing..."}`);

                pollStatus(realJobId, $card[0]);
                applyCardState(realJobId);
                sortImageCards();
              } else {
                $card.find(".status-text").html('<span class="badge bg-danger status-badge">❌ Submission Error</span>: No Job ID returned');
                $card.find(".progress-bar").addClass("bg-danger").css("width", "100%");
              }
            },
            error: function (xhr) {
                let errorMsg = "Submission failed.";
                if (xhr.responseJSON && xhr.responseJSON.error) { errorMsg = xhr.responseJSON.error; }
                else if (xhr.responseJSON && xhr.responseJSON.detail) {
                  if (Array.isArray(xhr.responseJSON.detail)) { errorMsg = xhr.responseJSON.detail.map(d => `${d.loc.join(".")} - ${d.msg}`).join("; "); }
                  else { errorMsg = xhr.responseJSON.detail; }
                }
                $card.find(".status-text").html(`<span class="badge bg-danger status-badge">❌ Error</span>: ${errorMsg}`);
                $card.find(".progress-bar").addClass("bg-danger").css("width", "100%");
            },
          });
        }
        $("#imageFiles").val("");
        updateAttachButtonStatus(); // Show button container if new cards were added
      });

      $("#results").on("click", ".refresh-btn", function () {
          const jobIdToRefresh = $(this).data("jobid");
          if (!jobIdToRefresh || jobIdToRefresh.startsWith('temp-')) {
              alert("Cannot re-process an item that hasn't finished initial submission.");
              return;
          }
          const $card = $(`#card-${jobIdToRefresh}`);
          if (!jobFileMap[jobIdToRefresh]) { alert("Original file not found for re-processing."); return; }

          const originalFile = jobFileMap[jobIdToRefresh];
          const model = $("#modelSelect").val();
          const postProcess = $("#postProcessCheck").is(":checked");
          const formData = new FormData();
          formData.append("image_file", originalFile);
          formData.append("api_key", apiKey);
          formData.append("model", model);
          formData.append("post_process", postProcess);

          $card.find(".status-text").html('<span class="badge bg-secondary status-badge">🔄 Re-submitting...</span>');
          $card.find(".progress-bar").removeClass("bg-success bg-danger").addClass("progress-bar-striped progress-bar-animated").css("width", "10%");
          $card.find(".beerslider-wrapper-container").addClass("img-placeholder").empty().text("Re-processing... (Slider will refresh)");
          $card.find(".refresh-btn").prop("disabled", true);
          $card.data("processed-url", null);
          $card.find(`input[name="image_choice_${jobIdToRefresh}"][value="processed"]`).data("url", null);
          $card.find('.select-for-attachment').prop('checked', false);

          $.ajax({
              url: submitApiUrl, method: "POST", data: formData, processData: false, contentType: false,
              success: function (newData) {
                  if (newData.job_id) {
                      const newJobId = newData.job_id;
                      // If job ID changed, update map and card attributes
                      if (jobIdToRefresh !== newJobId) {
                          delete jobFileMap[jobIdToRefresh]; // Remove old mapping
                          jobFileMap[newJobId] = originalFile; // Add new mapping

                          $card.attr("id", `card-${newJobId}`);
                          $card.data("job-id", newJobId);
                          $card.find(".job-id-text").text(`Job ID: ${newJobId}`);
                          $card.find(".refresh-btn").data("jobid", newJobId);
                          $card.find(".trash-btn").data("jobid", newJobId);
                          $card.find(`input[name="image_choice_${jobIdToRefresh}"]`).attr("name", `image_choice_${newJobId}`);
                          const $selectAttachInput = $card.find(`#select-attach-${jobIdToRefresh}`);
                          const newSelectAttachId = `select-attach-${newJobId}`;
                          $selectAttachInput.attr('id', newSelectAttachId);
                          $selectAttachInput.next('label').attr('for', newSelectAttachId);
                          // Update radio button labels' for attributes
                          $card.find(`label[for="image_choice_${jobIdToRefresh}_original"]`).attr('for', `image_choice_${newJobId}_original`);
                          $card.find(`label[for="image_choice_${jobIdToRefresh}_processed"]`).attr('for', `image_choice_${newJobId}_processed`);
                      }
                      $card.data("original-url", newData.original_image_url);
                      $card.find(`input[name="image_choice_${newJobId}"][value="original"]`).data("url", newData.original_image_url);
                      $card.find(".beerslider-wrapper-container.img-placeholder").html(`Original: Waiting for server URL<br>Processed: ${newData.status === "queued" ? "Queued" : "Processing..."}`);
                      pollStatus(newJobId, $card[0]);
                  } else {
                      $card.find(".status-text").html('<span class="badge bg-danger status-badge">❌ Re-submission Error</span>: No new Job ID.');
                      $card.find(".refresh-btn").prop("disabled", false);
                  }
              },
              error: function () {
                  $card.find(".status-text").html('<span class="badge bg-danger status-badge">❌ Re-submission Failed</span> (AJAX)');
                  $card.find(".refresh-btn").prop("disabled", false);
              }
          });
          updateAttachButtonStatus();
      });

      $("#results").on("change", ".select-for-attachment", function () {
        updateAttachButtonStatus();
      });
      // Radio button change doesn't directly trigger UI changes other than what modal picks up
      // $("#results").on("change", ".image-select-radio", function () { });

      $("#results").on("click", ".trash-btn", function () {
        const jobId = $(this).data("jobid");
        if (!jobId || jobId.startsWith('temp-')) return;

        if (isJobTrashed(jobId)) {
            removeJobIdFromStorage(TRASHED_JOB_IDS_KEY, jobId);
        } else {
            addJobIdToStorage(TRASHED_JOB_IDS_KEY, jobId);
            // Optional: If trashing an associated item, you might want to un-associate it.
            // removeJobIdFromStorage(ASSOCIATED_JOB_IDS_KEY, jobId);
        }
        applyCardState(jobId);
        sortImageCards();
      });

      $("#attachImagesButton").on("click", function () {
        const $selectedCheckboxes = $('#results .image-card:not(.trashed-card) .select-for-attachment:checked');
        if ($selectedCheckboxes.length === 0) {
          alert("Please select at least one non-trashed image to attach.");
          return;
        }

        const $listElement = $("#selectedImagesListModal").empty();
        $("#modalAlertPlaceholder").empty();
        $("#itemNumberInput").val('');

        $selectedCheckboxes.each(function () {
          const $card = $(this).closest(".image-card");
          const jobId = $card.data("job-id");
          const originalFileName = $card.data("original-filename");
          const selectedVersion = $card.find(`input[name="image_choice_${jobId}"]:checked`).val();
          let imageUrl = $card.find(`input[name="image_choice_${jobId}"][value="${selectedVersion}"]`).data("url");

          if (jobId && !jobId.startsWith("temp-") && imageUrl) {
            $listElement.append(
              `<li class="list-group-item"
                    data-job-id="${jobId}"
                    data-image-url="${imageUrl}"
                    data-original-filename="${originalFileName}"
                    data-selected-version="${selectedVersion}">
                 ${originalFileName} (${selectedVersion}) - <a href="${imageUrl}" target="_blank" class="small">View</a>
               </li>`
            );
          }
        });

        if ($listElement.children().length > 0) {
            itemAttachmentModalInstance.show();
        } else {
            alert("Selected images are not ready, have no URL, or an error occurred.");
        }
      });

      $("#itemAttachmentForm").on("submit", function(e) {
        e.preventDefault();
        const itemNumber = $("#itemNumberInput").val().trim();
        if (!itemNumber) {
          $("#modalAlertPlaceholder").html('<div class="alert alert-danger" role="alert">Item Number is required.</div>');
          return;
        }
        $("#modalAlertPlaceholder").empty();

        const imagesToAssociatePayload = [];
        const jobIdsToMarkAssociatedOnFrontend = [];

        $("#selectedImagesListModal .list-group-item").each(function() {
            const $li = $(this);
            const jobId = $li.data("job-id");
            const url = $li.data("image-url");
            const originalFileName = $li.data("original-filename");
            const selectedVersion = $li.data("selected-version");

            if (jobId && url) {
                imagesToAssociatePayload.push({
                    job_id: jobId,
                    image_url: url,
                    original_filename: originalFileName,
                    selected_version: selectedVersion
                });
                jobIdsToMarkAssociatedOnFrontend.push(jobId);
            }
        });

        if (imagesToAssociatePayload.length === 0) {
          $("#modalAlertPlaceholder").html('<div class="alert alert-warning" role="alert">No valid images to associate.</div>');
          return;
        }

        console.log("Submitting to backend:", { item_number: itemNumber, images: imagesToAssociatePayload });

        // --- SIMULATE BACKEND CALL ---
        // Replace this with your actual $.ajax call to 'associateApiUrl'
        // $.ajax({
        //   url: associateApiUrl,
        //   method: "POST",
        //   contentType: "application/json",
        //   data: JSON.stringify({ item_number: itemNumber, images: imagesToAssociatePayload }),
        //   success: function(response) {
        //     console.log("Association successful:", response);
            jobIdsToMarkAssociatedOnFrontend.forEach(jobId => {
                addJobIdToStorage(ASSOCIATED_JOB_IDS_KEY, jobId);
                removeJobIdFromStorage(TRASHED_JOB_IDS_KEY, jobId); // Associating untrashes
                applyCardState(jobId);
                $(`#card-${jobId} .select-for-attachment`).prop('checked', false);
            });
            itemAttachmentModalInstance.hide();
            sortImageCards();
            alert(`Images successfully associated with item number: ${itemNumber}`);
        //   },
        //   error: function(xhr) {
        //     let errorMsg = "Failed to associate images with item.";
        //     if (xhr.responseJSON && xhr.responseJSON.error) { errorMsg = xhr.responseJSON.error; }
        //     $("#modalAlertPlaceholder").html(`<div class="alert alert-danger" role="alert">${errorMsg}</div>`);
        //     console.error("Association error:", xhr);
        //   }
        // });
        // --- END SIMULATION ---
      });
    }); // End document.ready
  </script>
</body>
</html>
